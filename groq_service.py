from groq import AsyncGroq
from config import GROQ_API_KEY, GROQ_MODEL, GROQ_MAX_TOKENS
from typing import Dict
import json

client = AsyncGroq(api_key=GROQ_API_KEY)

class GroqService:
    @staticmethod
    async def generate_dishes(products: str, style: str = "–æ–±—ã—á–Ω—ã–π") -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–ª—é–¥–∞ —Å —É—á–µ—Ç–æ–º —Å—Ç–∏–ª—è –∏ –ö–£–õ–ò–ù–ê–†–ù–û–ô –õ–û–ì–ò–ö–ò.
        """
        prompt = f"""–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã: {products}.
        –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å): —Å–æ–ª—å, –ø–µ—Ä–µ—Ü, –≤–æ–¥–∞, —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –º–∞—Å–ª–æ, —Å–∞—Ö–∞—Ä, –º—É–∫–∞.

        –¢–≤–æ—è —Ä–æ–ª—å: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –®–µ—Ñ-–ø–æ–≤–∞—Ä.
        –ó–∞–¥–∞—á–∞: –ü—Ä–µ–¥–ª–æ–∂–∏ 6-8 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –±–ª—é–¥ –≤ —Å—Ç–∏–ª–µ: "{style}".

        üö® –ì–õ–ê–í–ù–´–ï –ü–†–ê–í–ò–õ–ê (–ö–£–õ–ò–ù–ê–†–ù–ê–Ø –õ–û–ì–ò–ö–ê):
        1. –í–ö–£–° –ü–†–ï–í–´–®–ï –í–°–ï–ì–û. –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –Ω–µ—Å—ä–µ–¥–æ–±–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—á–∏—Å–ª–∏–ª —ç—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç—ã. –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –±–ª—é–¥–∞ –¥–æ–ª–∂–Ω—ã –¥–æ–ø–æ–ª–Ω—è—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞, –∞ –Ω–µ –ø–µ—Ä–µ–±–∏–≤–∞—Ç—å. 
        2. –ó–ê–ü–†–ï–©–ï–ù–û —Å–º–µ—à–∏–≤–∞—Ç—å –Ω–µ—Å–æ—á–µ—Ç–∞–µ–º—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ä—ã–±–∞ + –º—è—Å–æ/—Å–∞–ª–æ, –º–æ–ª–æ–∫–æ + —Å–æ–ª–µ–Ω—ã–µ –æ–≥—É—Ä—Ü—ã/—Å–µ–ª–µ–¥–∫–∞, —Å–ª–∞–¥–∫–∏–µ —Ñ—Ä—É–∫—Ç—ã + —á–µ—Å–Ω–æ–∫/–ª—É–∫), –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–ª–∞—Å—Å–∏–∫–æ–π –≤—ã—Å–æ–∫–æ–π –∫—É—Ö–Ω–∏.
        3. –°–ï–ì–ú–ï–ù–¢–ê–¶–ò–Ø: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–ª —Å–ø–∏—Å–æ–∫ "{products}", –∏ —Ç–∞–º –µ—Å—Ç—å –∏ —Ä—ã–±–∞, –∏ –º—è—Å–æ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–¥–Ω–æ –±–ª—é–¥–æ —Å —Ä—ã–±–æ–π, –∞ –¥—Ä—É–≥–æ–µ —Å –º—è—Å–æ–º. –ù–ï –°–ú–ï–®–ò–í–ê–ô –∏—Ö –≤ –æ–¥–Ω–æ–π —Ç–∞—Ä–µ–ª–∫–µ.
        4. –ò—Å–ø–æ–ª—å–∑—É–π ~50% –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –Ω–æ —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, –∫–æ—Ç–æ—Ä—ã–µ –°–û–ß–ï–¢–ê–Æ–¢–°–Ø.
        5. –ï—Å–ª–∏ –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –±–ª—é–¥–∞ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç 1-2 –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –µ–≥–æ, –Ω–æ –Ω–∞–ø–∏—à–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏: "–ù–∞–∑–≤–∞–Ω–∏–µ (–¥–æ–∫—É–ø–∏—Ç—å: ...)".

        –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
        üçΩÔ∏è –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞
        –ö—Ä–∞—Ç–∫–æ–µ, –∞–ø–ø–µ—Ç–∏—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ - –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è.

        –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å: 'üé§ –ù–∞–∑–æ–≤–∏—Ç–µ –±–ª—é–¥–æ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã'."""

        response = await client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[{"role": "user", "content": prompt}],
            max_tokens=GROQ_MAX_TOKENS,
            temperature=0.5 # –°–Ω–∏–∑–∏–ª –¥–ª—è –±–æ–ª—å—à–µ–π –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç–∏
        )
        return response.choices[0].message.content
    
    @staticmethod
    async def determine_intent(user_message: str, dish_list: str) -> Dict:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        """
        prompt = f"""–ö–æ–Ω—Ç–µ–∫—Å—Ç (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –±–ª—é–¥–∞):
        {dish_list}

        –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{user_message}"

        –¢–≤–æ—è –∑–∞–¥–∞—á–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —á—Ç–æ —Ö–æ—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
        1. –ï—Å–ª–∏ –æ–Ω –Ω–∞–∑—ã–≤–∞–µ—Ç –±–ª—é–¥–æ –∏–∑ —Å–ø–∏—Å–∫–∞ (–∏–ª–∏ –ø–æ—Ö–æ–∂–µ–µ) -> "select_dish".
        2. –ï—Å–ª–∏ –æ–Ω –ø–∏—à–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–µ—â–µ –µ—Å—Ç—å –ª—É–∫", "–¥–æ–±–∞–≤—å —Ö–ª–µ–±", "–ø–æ–º–∏–¥–æ—Ä—ã") -> "add_products".
        3. –ï—Å–ª–∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ -> "unclear".

        –í–ï–†–ù–ò –¢–û–õ–¨–ö–û JSON. 
        –ü—Ä–∏–º–µ—Ä: {{"intent": "select_dish", "dish_name": "–ë–æ—Ä—â"}}
        –ü—Ä–∏–º–µ—Ä: {{"intent": "add_products", "products": "–ª—É–∫, –º–æ—Ä–∫–æ–≤—å"}}
        """

        response = await client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[{"role": "user", "content": prompt}],
            max_tokens=200,
            temperature=0.1
        )
        
        raw_result = response.choices[0].message.content.strip()
        
        # –ü–∞—Ä—Å–∏–Ω–≥ JSON
        try:
            start_index = raw_result.find('{')
            end_index = raw_result.rfind('}')
            
            if start_index != -1 and end_index != -1:
                json_str = raw_result[start_index : end_index + 1]
                return json.loads(json_str)
            else:
                return {"intent": "unclear"}
        except Exception:
            return {"intent": "unclear"}
            
    @staticmethod
    async def generate_recipe(dish_name: str, products: str) -> str:
        prompt = f"""–ù–∞–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç: "{dish_name}".
        –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {products}.
        
        –¢–≤–æ—è –∑–∞–¥–∞—á–∞: –°–æ—Å—Ç–∞–≤–∏—Ç—å –†–ï–ê–õ–ò–°–¢–ò–ß–ù–´–ô –∏ –í–ö–£–°–ù–´–ô —Ä–µ—Ü–µ–ø—Ç.
        
        –ï—Å–ª–∏ –±–ª—é–¥–æ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ (–∏ –æ–Ω–∏ –Ω–µ –±–∞–∑–æ–≤—ã–µ —Ç–∏–ø–∞ —Å–æ–ª–∏/–≤–æ–¥—ã) ‚Äî –Ω–∞–ø–∏—à–∏ –∏—Ö –≤ —Ä–∞–∑–¥–µ–ª–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Å –ø–æ–º–µ—Ç–∫–æ–π (–¥–æ–∫—É–ø–∏—Ç—å).
        –ù–µ –ø—ã—Ç–∞–π—Å—è –≤–ø–∏—Ö–Ω—É—Ç—å –Ω–µ–≤–ø–∏—Ö—É–µ–º–æ–µ. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–ª "—Å–∞–ª–æ" –∏ "—Ä—ã–±—É", –∞ –≥–æ—Ç–æ–≤–∏–º –º—ã —Ä—ã–±—É ‚Äî –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç—É–¥–∞ —Å–∞–ª–æ, –µ—Å–ª–∏ —ç—Ç–æ –∏—Å–ø–æ—Ä—Ç–∏—Ç –≤–∫—É—Å.

        –§–æ—Ä–º–∞—Ç:
        üçΩÔ∏è [–ù–∞–∑–≤–∞–Ω–∏–µ]
        
        üõí –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:
        (–ü–æ–º–µ—Ç—å ‚úÖ —Ç–æ, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å, –∏ üõí —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å)

        üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:
        1. ...
        2. ...
        """

        response = await client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[{"role": "user", "content": prompt}],
            max_tokens=GROQ_MAX_TOKENS,
            temperature=0.5
        )
        return response.choices[0].message.content

    @staticmethod
    async def generate_freestyle_recipe(dish_name: str) -> str:
        prompt = f"""–ù–∞–ø–∏—à–∏ –∫–ª–∞—Å—Å–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –±–ª—é–¥–∞: "{dish_name}".
        –ü–∏—à–∏ —Å –¥—É—à–æ–π, –∫–∞–∫ —à–µ—Ñ-–ø–æ–≤–∞—Ä.
        –†–µ—Ü–µ–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –∏ –≤–∫—É—Å–Ω—ã–º."""

        response = await client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[{"role": "user", "content": prompt}],
            max_tokens=GROQ_MAX_TOKENS,
            temperature=0.6
        )
        return response.choices[0].message.content
