from groq import AsyncGroq
from config import GROQ_API_KEY, GROQ_MODEL, GROQ_MAX_TOKENS
from typing import Dict, List, Union
import json
import re
import logging

client = AsyncGroq(api_key=GROQ_API_KEY)
logger = logging.getLogger(__name__)

class GroqService:
    
    # --- –ë–ê–ó–û–í–´–ô –ú–ï–¢–û–î –ó–ê–ü–†–û–°–ê ---
    @staticmethod
    async def _send_groq_request(system_prompt: str, user_text: str, temperature: float = 0.5, max_tokens: int = 1500) -> str:
        try:
            response = await client.chat.completions.create(
                model=GROQ_MODEL,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_text}
                ],
                max_tokens=max_tokens,
                temperature=temperature
            )
            return response.choices[0].message.content.strip()
        except Exception as e:
            logger.error(f"Groq API Error: {e}")
            return ""

    # --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ô –ú–ï–¢–û–î –î–õ–Ø –ü–ê–†–°–ò–ù–ì–ê JSON ---
    @staticmethod
    def _extract_json(text: str) -> str:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞, –Ω–∞—Ö–æ–¥—è –ø–µ—Ä–≤—É—é { –∏–ª–∏ [ –∏ –ø–æ—Å–ª–µ–¥–Ω—é—é } –∏–ª–∏ ]"""
        # –£–±–∏—Ä–∞–µ–º markdown –±–ª–æ–∫–∏
        text = text.replace("```json", "").replace("```", "")
        
        # –ò—â–µ–º –≥—Ä–∞–Ω–∏—Ü—ã JSON
        start_brace = text.find('{')
        start_bracket = text.find('[')
        
        # –ë–µ—Ä—ë–º –ø–µ—Ä–≤–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ (—á—Ç–æ —Ä–∞–Ω—å—à–µ –∏–¥—ë—Ç)
        if start_brace == -1:
            start = start_bracket
        elif start_bracket == -1:
            start = start_brace
        else:
            start = min(start_brace, start_bracket)
        
        # –ò—â–µ–º –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Å–∫–æ–±–∫–∏ —Å –∫–æ–Ω—Ü–∞
        end_brace = text.rfind('}')
        end_bracket = text.rfind(']')
        end = max(end_brace, end_bracket)
        
        if start != -1 and end != -1 and end > start:
            return text[start:end+1]
        
        return text.strip()

    # --- –õ–û–ì–ò–ö–ê ---

    @staticmethod
    async def validate_ingredients(text: str) -> bool:
        prompt = """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—Å—Ç –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å.

üìã –ö–†–ò–¢–ï–†–ò–ò –í–ê–õ–ò–î–ù–û–°–¢–ò:
‚úÖ –ü–†–ò–ù–Ø–¢–¨ –µ—Å–ª–∏:
- –°—ä–µ–¥–æ–±–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–º—è—Å–æ, –æ–≤–æ—â–∏, –∫—Ä—É–ø—ã, –º–æ–ª–æ–∫–æ –∏ —Ç.–¥.)
- –î–æ–ø—É—Å—Ç–∏–º—ã –æ–ø–µ—á–∞—Ç–∫–∏ ("–∫–∞—Ä—Ä—Ç–æ—Ñ–µ–ª—å", "–º–æ–ª–∫–æ")
- –î–æ–ø—É—Å—Ç–∏–º—ã –æ–±—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ("–∑–µ–ª–µ–Ω—å", "—Å–ø–µ—Ü–∏–∏")

‚ùå –û–¢–ö–õ–û–ù–ò–¢–¨ –µ—Å–ª–∏:
- –ù–µ—Å—ä–µ–¥–æ–±–Ω–æ–µ (–±–µ–Ω–∑–∏–Ω, —Å—Ç–µ–∫–ª–æ, —Ö–∏–º–∏–∫–∞—Ç—ã)
- –ë–µ—Å—Å–º—ã—Å–ª–∏—Ü–∞ ("–∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–∞", "—Ñ—ã–≤–∞ –æ–ª–¥–∂")
- –¢–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è ("–ø—Ä–∏–≤–µ—Ç", "hello")
- –ü—É—Å—Ç–æ–π –≤–≤–æ–¥ –∏–ª–∏ <3 —Å–∏–º–≤–æ–ª–æ–≤

üéØ –°–¢–†–û–ì–ò–ô –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
{"valid": true, "reason": "–∫—Ä–∞—Ç–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞"}
–∏–ª–∏
{"valid": false, "reason": "–∫—Ä–∞—Ç–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞"}

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å "{" –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è "}"
–ù–ï –¥–æ–±–∞–≤–ª—è–π:
- –í–≤–æ–¥–Ω—ã–µ —Ñ—Ä–∞–∑—ã ("–í–æ—Ç JSON:", "–ö–æ–Ω–µ—á–Ω–æ!")
- Markdown (```json```)
- –ü–æ—è—Å–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ JSON

–ü–ï–†–í–´–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "{"
–ü–û–°–õ–ï–î–ù–ò–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "}"
"""
        
        res = await GroqService._send_groq_request(prompt, f'üìù –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º—ã–π —Ç–µ–∫—Å—Ç: "{text}"', 0.1)
        
        try:
            clean_json = GroqService._extract_json(res)
            data = json.loads(clean_json)
            return data.get("valid", False)
        except Exception as e:
            logger.error(f"Validation JSON Error: {e}, Response: {res}")
            # –§–æ–ª–±—ç–∫ –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
            return "true" in res.lower()

    @staticmethod
    async def analyze_categories(products: str) -> List[str]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
        Mix –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ >= 5.
        """
        items_count = len(re.split(r'[,;]', products))
        allow_mix = items_count >= 5
        
        mix_rule = """- "mix" (–∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –æ–±–µ–¥ ‚Äî –°–ï–¢ –∏–∑ 2-3 –±–ª—é–¥ —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π)
‚ö†Ô∏è "mix" –¥–æ—Å—Ç—É–ø–µ–Ω –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚â•5 (–∏–Ω–∞—á–µ –Ω–µ —Ö–≤–∞—Ç–∏—Ç –Ω–∞ —Å–µ—Ç)""" if allow_mix else """‚ö†Ô∏è "mix" –ù–ï–î–û–°–¢–£–ü–ï–ù (–ø—Ä–æ–¥—É–∫—Ç–æ–≤ <5)"""

        prompt = f"""–¢—ã –æ–ø—ã—Ç–Ω—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä. –û–ø—Ä–µ–¥–µ–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª—é–¥, –∫–æ—Ç–æ—Ä—ã–µ –†–ï–ê–õ–¨–ù–û –º–æ–∂–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å.

üõí –ü–†–û–î–£–ö–¢–´: {products}
üì¶ –ë–ê–ó–ê (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞): —Å–æ–ª—å, —Å–∞—Ö–∞—Ä, –≤–æ–¥–∞, –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ –º–∞—Å–ª–æ, —Å–ø–µ—Ü–∏–∏, –ª—ë–¥

üìö –ö–ê–¢–ï–ì–û–†–ò–ò:
- "soup" (—Å—É–ø—ã ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Å–Ω–æ–≤–∞ –¥–ª—è –±—É–ª—å–æ–Ω–∞)
- "main" (–≤—Ç–æ—Ä—ã–µ –±–ª—é–¥–∞ ‚Äî –º—è—Å–æ/—Ä—ã–±–∞/–∫—Ä—É–ø—ã)
- "salad" (—Å–∞–ª–∞—Ç—ã ‚Äî –æ–≤–æ—â–∏/–∑–µ–ª–µ–Ω—å)
- "breakfast" (–∑–∞–≤—Ç—Ä–∞–∫–∏ ‚Äî —è–π—Ü–∞/–º–æ–ª–æ–∫–æ/—Ö–ª–µ–±)
- "dessert" (–¥–µ—Å–µ—Ä—Ç—ã ‚Äî —Å–∞—Ö–∞—Ä + —Ñ—Ä—É–∫—Ç—ã/–º–æ–ª–æ–∫–æ)
- "drink" (–Ω–∞–ø–∏—Ç–∫–∏ ‚Äî —Ñ—Ä—É–∫—Ç—ã/–º–æ–ª–æ–∫–æ/—á–∞–π)
- "snack" (–∑–∞–∫—É—Å–∫–∏ ‚Äî –±—ã—Å—Ç—Ä—ã–µ –±–ª—é–¥–∞)
{mix_rule}

‚ö†Ô∏è –ü–†–ê–í–ò–õ–ê:
1. –í–æ–∑–≤—Ä–∞—â–∞–π 1-3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–µ –≤—Å–µ —Å—Ä–∞–∑—É!)
2. –ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ‚Äî –≤—ã–±–µ—Ä–∏ —Å–∞–º—ã–µ –æ—á–µ–≤–∏–¥–Ω—ã–µ
3. –ù–µ –¥–æ–±–∞–≤–ª—è–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π" ‚Äî —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ

üìñ –ü–†–ò–ú–ï–†–´:
–ü—Ä–æ–¥—É–∫—Ç—ã: "–∫—É—Ä–∏—Ü–∞, —Ä–∏—Å" ‚Üí ["main"]
–ü—Ä–æ–¥—É–∫—Ç—ã: "–ø–æ–º–∏–¥–æ—Ä—ã, –æ–≥—É—Ä—Ü—ã, –ª—É–∫, –ø–µ—Ä–µ—Ü, —è–π—Ü–∞" ‚Üí ["salad", "breakfast"]
–ü—Ä–æ–¥—É–∫—Ç—ã: "–≥–æ–≤—è–¥–∏–Ω–∞, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –º–æ—Ä–∫–æ–≤—å, –ª—É–∫, –∫–∞–ø—É—Å—Ç–∞, —Ä–∏—Å" ‚Üí ["soup", "main", "mix"]

üéØ –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–¢–û–õ–¨–ö–û JSON):
["–∫–∞—Ç–µ–≥–æ—Ä–∏—è1", "–∫–∞—Ç–µ–≥–æ—Ä–∏—è2"]

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
–ü–ï–†–í–´–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "["
–ü–û–°–õ–ï–î–ù–ò–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "]"
–ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –¥–æ/–ø–æ—Å–ª–µ JSON!
"""
        
        res = await GroqService._send_groq_request(prompt, "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", 0.2)
        
        try:
            clean_json = GroqService._extract_json(res)
            data = json.loads(clean_json)
            if isinstance(data, list):
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ mix
                if "mix" in data and not allow_mix:
                    data.remove("mix")
                    logger.warning(f"Removed 'mix' category: not enough products ({items_count} < 5)")
                return data
        except Exception as e:
            logger.error(f"Categories JSON Error: {e}, Response: {res}")
        
        return ["main"]

    @staticmethod
    async def generate_dishes_list(products: str, category: str) -> List[Dict[str, str]]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –±–ª—é–¥ –∏–ª–∏ —Å–µ—Ç–æ–≤.
        """
        items_count = len(re.split(r'[,]', products))
        
        # –¢–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–º–µ—Å—Ç–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
        if items_count <= 2:
            target_count = 2
        elif items_count <= 5:
            target_count = 4
        else:
            target_count = 5

        cat_names = {
            "soup": "–°—É–ø—ã", "main": "–í—Ç–æ—Ä—ã–µ –±–ª—é–¥–∞", "salad": "–°–∞–ª–∞—Ç—ã", 
            "breakfast": "–ó–∞–≤—Ç—Ä–∞–∫–∏", "dessert": "–î–µ—Å–µ—Ä—Ç—ã", "drink": "–ù–∞–ø–∏—Ç–∫–∏", 
            "snack": "–ó–∞–∫—É—Å–∫–∏", "mix": "–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –æ–±–µ–¥—ã"
        }
        cat_ru = cat_names.get(category, "–ë–ª—é–¥–∞")

        if category == "mix":
            mix_specific = """
üç± –°–ü–ï–¶–ò–§–ò–ö–ê –°–ï–¢–û–í:
- –ö–∞–∂–¥—ã–π —Å–µ—Ç = 2-3 –°–û–ß–ï–¢–ê–Æ–©–ò–•–°–Ø –±–ª—é–¥–∞ (–°—É–ø+–°–∞–ª–∞—Ç, –í—Ç–æ—Ä–æ–µ+–ù–∞–ø–∏—Ç–æ–∫)
- –ù–ï –¥—É–±–ª–∏—Ä—É–π –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–¥—É–∫—Ç –º–µ–∂–¥—É –±–ª—é–¥–∞–º–∏ —Å–µ—Ç–∞ (–µ—Å–ª–∏ –º—è—Å–æ –≤ —Å—É–ø–µ ‚Äî –Ω–µ –∫–ª–∞–¥–∏ –≤ —Å–∞–ª–∞—Ç)
- –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ç–∞: "–û–±–µ–¥ ‚Ññ1: [–ë–ª—é–¥–æ] + [–ë–ª—é–¥–æ]"
- –û–ø–∏—Å–∞–Ω–∏–µ: –ø–µ—Ä–µ—á–∏—Å–ª–∏ —Å–æ—Å—Ç–∞–≤ –∫–∞–∂–¥–æ–≥–æ –±–ª—é–¥–∞ –≤ —Å–µ—Ç–µ"""
            
            prompt = f"""üìù –ó–ê–î–ê–ù–ò–ï: –°–æ—Å—Ç–∞–≤—å –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "{cat_ru}".

üõí –ü–†–û–î–£–ö–¢–´: {products}
üì¶ –ë–ê–ó–ê: —Å–æ–ª—å, —Å–∞—Ö–∞—Ä, –≤–æ–¥–∞, –º–∞—Å–ª–æ, —Å–ø–µ—Ü–∏–∏

üéØ –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ç–æ–≤: –°–¢–†–û–ì–û {target_count} (–Ω–µ –±–æ–ª—å—à–µ, –Ω–µ –º–µ–Ω—å—à–µ!)
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞ + –±–∞–∑–∞
- –ù–∞–∑–≤–∞–Ω–∏—è ‚Äî –∞–ø–ø–µ—Ç–∏—Ç–Ω—ã–µ, –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
- –û–ø–∏—Å–∞–Ω–∏—è ‚Äî 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –≤—ã–∑—ã–≤–∞—é—Ç –∞–ø–ø–µ—Ç–∏—Ç
{mix_specific}

üìñ –ü–†–ò–ú–ï–† –§–û–†–ú–ê–¢–ê:
[
  {{
    "name": "–û–±–µ–¥ ‚Ññ1: –ö—É—Ä–∏–Ω—ã–π —Å—É–ø + –û–≤–æ—â–Ω–æ–π —Å–∞–ª–∞—Ç",
    "desc": "–ê—Ä–æ–º–∞—Ç–Ω—ã–π —Å—É–ø —Å –∫—É—Ä–∏—Ü–µ–π –∏ –ª–∞–ø—à–æ–π. –°–≤–µ–∂–∏–π —Å–∞–ª–∞—Ç –∏–∑ –ø–æ–º–∏–¥–æ—Ä–æ–≤ –∏ –æ–≥—É—Ä—Ü–æ–≤ —Å –º–∞—Å–ª–æ–º."
  }}
]

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
–ü–ï–†–í–´–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "["
–ü–û–°–õ–ï–î–ù–ò–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "]"
–°–¢–†–û–ì–ò–ô JSON! –ë–ï–ó –¢–ï–ö–°–¢–ê –î–û/–ü–û–°–õ–ï!
"""
        else:
            prompt = f"""üìù –ó–ê–î–ê–ù–ò–ï: –°–æ—Å—Ç–∞–≤—å –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "{cat_ru}".

üõí –ü–†–û–î–£–ö–¢–´: {products}
üì¶ –ë–ê–ó–ê: —Å–æ–ª—å, —Å–∞—Ö–∞—Ä, –≤–æ–¥–∞, –º–∞—Å–ª–æ, —Å–ø–µ—Ü–∏–∏

üéØ –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª—é–¥: –°–¢–†–û–ì–û {target_count} (–Ω–µ –±–æ–ª—å—à–µ, –Ω–µ –º–µ–Ω—å—à–µ!)
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞ + –±–∞–∑–∞
- –ù–∞–∑–≤–∞–Ω–∏—è ‚Äî –∞–ø–ø–µ—Ç–∏—Ç–Ω—ã–µ, –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
- –û–ø–∏—Å–∞–Ω–∏—è ‚Äî 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –≤—ã–∑—ã–≤–∞—é—Ç –∞–ø–ø–µ—Ç–∏—Ç

üìñ –ü–†–ò–ú–ï–† –§–û–†–ú–ê–¢–ê:
[
  {{
    "name": "–ö—É—Ä–∏–Ω—ã–π —Å—É–ø —Å –ª–∞–ø—à–æ–π",
    "desc": "–ê—Ä–æ–º–∞—Ç–Ω—ã–π –±—É–ª—å–æ–Ω —Å –Ω–µ–∂–Ω–æ–π –∫—É—Ä–∏—Ü–µ–π –∏ –¥–æ–º–∞—à–Ω–µ–π –ª–∞–ø—à–æ–π. –°–æ–≥—Ä–µ–≤–∞–µ—Ç –≤ —Ö–æ–ª–æ–¥–Ω—ã–π –¥–µ–Ω—å."
  }}
]

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
–ü–ï–†–í–´–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "["
–ü–û–°–õ–ï–î–ù–ò–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "]"
–°–¢–†–û–ì–ò–ô JSON! –ë–ï–ó –¢–ï–ö–°–¢–ê –î–û/–ü–û–°–õ–ï!
"""
        
        res = await GroqService._send_groq_request(prompt, "–ì–µ–Ω–µ—Ä–∏—Ä—É–π –º–µ–Ω—é", 0.5)
        
        try:
            clean_json = GroqService._extract_json(res)
            data = json.loads(clean_json)
            if isinstance(data, list):
                return data
        except Exception as e:
            logger.error(f"Dishes JSON Error: {e}, Response: {res}")
        
        return []

    @staticmethod
    async def generate_recipe(dish_name: str, products: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ—Ü–µ–ø—Ç –≤ —Å—Ç—Ä–æ–≥–æ–º —Ñ–æ—Ä–º–∞—Ç–µ —Å–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤.
        """
        is_mix = any(x in dish_name.lower() for x in ["–æ–±–µ–¥", "—Å–µ—Ç", "–∫–æ–º–ø–ª–µ–∫—Å", "+"])
        
        mix_instruction = ""
        if is_mix:
            mix_instruction = """
üç± –≠–¢–û –°–ï–¢ –ò–ó –ù–ï–°–ö–û–õ–¨–ö–ò–• –ë–õ–Æ–î:
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –º–µ–∂–¥—É –±–ª—é–¥–∞–º–∏ –ª–æ–≥–∏—á–Ω–æ
- –ù–ï –¥—É–±–ª–∏—Ä—É–π –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç (–º—è—Å–æ/—Ä—ã–±—É) –º–µ–∂–¥—É –±–ª—é–¥–∞–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª—é–¥–∞ –≤ —Å–µ—Ç–µ
- –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –≥—Ä—É–ø–ø–∏—Ä—É–π –ø–æ –±–ª—é–¥–∞–º —á–µ—Ä–µ–∑ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏, –Ω–æ —Å–ø–∏—Å–∫–∏ –¥–µ–ª–∞–π —á–µ—Ä–µ–∑ —Ç–∏—Ä–µ (-)
"""

        prompt = f"""–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —à–µ—Ñ. –ù–∞–ø–∏—à–∏ —Ä–µ—Ü–µ–ø—Ç: "{dish_name}".

üõí –ü–†–û–î–£–ö–¢–´: {products}
üì¶ –ë–ê–ó–ê (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞): —Å–æ–ª—å, —Å–∞—Ö–∞—Ä, –≤–æ–¥–∞, –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ –º–∞—Å–ª–æ, —Å–ø–µ—Ü–∏–∏
{mix_instruction}

üìã –°–¢–†–û–ì–ò–ô –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å–ª–µ–¥—É–π —Ç–æ—á–Ω–æ):

[–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞]

üì¶ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:
- [–ø—Ä–æ–¥—É–∫—Ç] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ]
- [–ø—Ä–æ–¥—É–∫—Ç] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ]
(–ï—Å–ª–∏ —Å–µ—Ç ‚Äî –¥–µ–ª–∞–π –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª—é–¥–∞, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–∏—Ä–µ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤)

üìä –ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ 1 –ø–æ—Ä—Ü–∏—é (–ø—Ä–∏–º–µ—Ä–Ω–æ):
ü•ö –ë–µ–ª–∫–∏: X –≥
ü•ë –ñ–∏—Ä—ã: X –≥
üåæ –£–≥–ª–µ–≤–æ–¥—ã: X –≥
‚ö° –≠–Ω–µ—Ä–≥. —Ü–µ–Ω–Ω–æ—Å—Ç—å: X –∫–∫–∞–ª

‚è± –í—Ä–µ–º—è: X –º–∏–Ω—É—Ç
üéö –°–ª–æ–∂–Ω–æ—Å—Ç—å: [–ª–µ–≥–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/—Å–ª–æ–∂–Ω–∞—è]
üë• –ü–æ—Ä—Ü–∏–∏: X —á–µ–ª.

üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:
1. [–ø–æ–¥—Ä–æ–±–Ω—ã–π —à–∞–≥]
2. [–ø–æ–¥—Ä–æ–±–Ω—ã–π —à–∞–≥]
3. [–ø–æ–¥—Ä–æ–±–Ω—ã–π —à–∞–≥]
(–î–ª—è —Å–µ—Ç–∞ ‚Äî –Ω—É–º–µ—Ä—É–π —à–∞–≥–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö –±–ª—é–¥)

üí° –°–û–í–ï–¢ –®–ï–§-–ü–û–í–ê–†–ê (–ö–£–õ–ò–ù–ê–†–ù–ê–Ø –¢–†–ò–ê–î–ê): Analyze Taste, Aroma and Texture. Recommend ONE missing item for balance.
"""

        res = await GroqService._send_groq_request(prompt, "–ù–∞–ø–∏—à–∏ —Ä–µ—Ü–µ–ø—Ç", 0.4, max_tokens=2000)
        
        if GroqService._is_refusal(res): 
            return res
        
        return res + "\n\nüë®‚Äçüç≥ <b>–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!</b>"

    @staticmethod
    async def generate_freestyle_recipe(dish_name: str) -> str:
        prompt = f"""–¢—ã –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä –∏ —Ñ–∏–ª–æ—Å–æ—Ñ –∫—É—Ö–Ω–∏. –°–æ–∑–¥–∞–π —Ä–µ—Ü–µ–ø—Ç: "{dish_name}"

üîç –ê–ù–ê–õ–ò–ó –ó–ê–ü–†–û–°–ê:
–ï—Å–ª–∏ —ç—Ç–æ –ï–î–ê (–ø–∏—Ü—Ü–∞, –±–æ—Ä—â, —Ç–æ—Ä—Ç) ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç —Å –ö–ë–ñ–£
–ï—Å–ª–∏ —ç—Ç–æ –ú–ï–¢–ê–§–û–†–ê (—Å—á–∞—Å—Ç—å–µ, —É—Å–ø–µ—Ö, –ª—é–±–æ–≤—å) ‚Üí —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π —Ä–µ—Ü–µ–ø—Ç-–∞–ª–ª–µ–≥–æ—Ä–∏—è

üìã –§–û–†–ú–ê–¢ –î–õ–Ø –ï–î–´:

[–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞]

üì¶ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:
- [–ø—Ä–æ–¥—É–∫—Ç] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ]

üìä –ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å (–ø—Ä–∏–º–µ—Ä–Ω–æ):
ü•ö –ë–µ–ª–∫–∏: X –≥ | ü•ë –ñ–∏—Ä—ã: X –≥ | üåæ –£–≥–ª–µ–≤–æ–¥—ã: X –≥ | ‚ö° –ö–∞–ª–æ—Ä–∏–∏: X –∫–∫–∞–ª

‚è± –í—Ä–µ–º—è: X –º–∏–Ω | üéö –°–ª–æ–∂–Ω–æ—Å—Ç—å: [–ª–µ–≥–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è] | üë• –ü–æ—Ä—Ü–∏–π: X

üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:
1. [—à–∞–≥]
2. [—à–∞–≥]

üí° –°–û–í–ï–¢ –®–ï–§–ê: [–ø—Ä–æ –≤–∫—É—Å/–∞—Ä–æ–º–∞—Ç/—Ç–µ–∫—Å—Ç—É—Ä—É]

---

üìã –§–û–†–ú–ê–¢ –î–õ–Ø –ú–ï–¢–ê–§–û–†–´:

üé≠ –†–µ—Ü–µ–ø—Ç "{dish_name}"

üì¶ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (—Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ):
- [–∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–µ –ø–æ–Ω—è—Ç–∏–µ] ‚Äî [–º–µ—Ç–∞—Ñ–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞]
–ü—Ä–∏–º–µ—Ä: "3 —á–∞—à–∫–∏ —Ç–µ—Ä–ø–µ–Ω–∏—è", "—â–µ–ø–æ—Ç–∫–∞ —é–º–æ—Ä–∞"

üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ (—Ñ–∏–ª–æ—Å–æ—Ñ–∏—è):
1. [–º—É–¥—Ä—ã–π —Å–æ–≤–µ—Ç –≤ —Å—Ç–∏–ª–µ –∫—É–ª–∏–Ω–∞—Ä–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏]
2. [–µ—â—ë —Å–æ–≤–µ—Ç]

‚è± –í—Ä–µ–º—è —Å–æ–∑—Ä–µ–≤–∞–Ω–∏—è: [–º–µ—Ç–∞—Ñ–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏]
–ü—Ä–∏–º–µ—Ä: "–í—Å—é –∂–∏–∑–Ω—å" –∏–ª–∏ "21 –¥–µ–Ω—å –ø—Ä–∏–≤—ã—á–∫–∏"

üí° –°–ï–ö–†–ï–¢ –ë–õ–Æ–î–ê: [–≥–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å –æ–¥–Ω–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º]

‚ö†Ô∏è –ù–ï —Å–º–µ—à–∏–≤–∞–π —Ñ–æ—Ä–º–∞—Ç—ã! –õ–∏–±–æ —Ä–µ–∞–ª—å–Ω–∞—è –µ–¥–∞, –ª–∏–±–æ –º–µ—Ç–∞—Ñ–æ—Ä–∞.
–î–ª—è –º–µ—Ç–∞—Ñ–æ—Ä –∏—Å–ø–æ–ª—å–∑—É–π –∫—É–ª–∏–Ω–∞—Ä–Ω—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é (–ø–µ—Ä–µ–º–µ—à–∞–π, –¥–∞–π –Ω–∞—Å—Ç–æ—è—Ç—å—Å—è, –ø–æ–¥–∞–≤–∞–π —Ç—ë–ø–ª—ã–º).
"""
        
        res = await GroqService._send_groq_request(prompt, "–°–æ–∑–¥–∞–π —Ä–µ—Ü–µ–ø—Ç", 0.6, max_tokens=2000)
        
        if GroqService._is_refusal(res):
            return res
        
        return res + "\n\nüë®‚Äçüç≥ <b>–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!</b>"

    @staticmethod
    def _is_refusal(text: str) -> bool:
        if "‚õî" in text:
            return True
        refusals = ["cannot fulfill", "cannot answer", "against my policy", "–Ω–µ –º–æ–≥—É –≤—ã–ø–æ–ª–Ω–∏—Ç—å"]
        for ph in refusals:
            if ph in text.lower():
                return True
        return False