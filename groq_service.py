from groq import AsyncGroq
from config import GROQ_API_KEY, GROQ_MODEL, GROQ_MAX_TOKENS
from typing import Dict
import json

client = AsyncGroq(api_key=GROQ_API_KEY)

class GroqService:
    @staticmethod
    async def generate_dishes(products: str, style: str = "–æ–±—ã—á–Ω—ã–π") -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–ª—é–¥–∞ —Å —É—á–µ—Ç–æ–º —Å—Ç–∏–ª—è –∏ –ø—Ä–∞–≤–∏–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤.
        style: 'ordinary' (–ø—Ä–æ—Å—Ç–æ–µ) –∏–ª–∏ 'exotic' (—ç–∫–∑–æ—Ç–∏—á–µ—Å–∫–æ–µ)
        """
        
        prompt = f"""–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã: {products}.
        –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å): —Å–æ–ª—å, –ø–µ—Ä–µ—Ü, –≤–æ–¥–∞, —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –º–∞—Å–ª–æ, —Å–∞—Ö–∞—Ä.

        –ó–∞–¥–∞—á–∞: –ü—Ä–µ–¥–ª–æ–∂–∏ 3-5 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –±–ª—é–¥ –≤ —Å—Ç–∏–ª–µ: "{style}".

        –°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê:
        1. –ò—Å–ø–æ–ª—å–∑—É–π –ù–ï –ú–ï–ù–ï–ï 50% –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –∫–∞–∂–¥–æ–º —Ä–µ—Ü–µ–ø—Ç–µ.
        2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî —Ä–µ—Ü–µ–ø—Ç—ã, –≥–¥–µ –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞–ª–∏—á–∏–∏.
        3. –ï—Å–ª–∏ –¥–ª—è –∫—Ä—É—Ç–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç 1-2 –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ (–∫—Ä–æ–º–µ –±–∞–∑–æ–≤—ã—Ö), –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –µ–≥–æ, –Ω–æ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∂–∏: "–ù–∞–∑–≤–∞–Ω–∏–µ (–¥–æ–∫—É–ø–∏—Ç—å: ...)".
        4. –ï—Å–ª–∏ —Å—Ç–∏–ª—å "—ç–∫–∑–æ—Ç–∏—á–µ—Å–∫–∏–π" ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞–π –Ω–µ–æ–±—ã—á–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è –∏–ª–∏ –±–ª—é–¥–∞ –∞–∑–∏–∞—Ç—Å–∫–æ–π/–º–µ–∫—Å–∏–∫–∞–Ω—Å–∫–æ–π/—Ñ—å—é–∂–Ω –∫—É—Ö–Ω–∏.
        5. –ï—Å–ª–∏ —Å—Ç–∏–ª—å "–ø—Ä–æ—Å—Ç–æ–π" ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞–π –¥–æ–º–∞—à–Ω—é—é, –ø–æ–Ω—è—Ç–Ω—É—é –∫–ª–∞—Å—Å–∏–∫—É.

        –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
        üçΩÔ∏è –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ [–µ—Å–ª–∏ –Ω–∞–¥–æ –¥–æ–∫—É–ø–∏—Ç—å, –ø–∏—à–∏ —Ç—É—Ç –≤ —Å–∫–æ–±–∫–∞—Ö] - –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è.

        –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å —Ñ—Ä–∞–∑—É: 'üé§ –í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–æ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã'."""

        response = await client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[{"role": "user", "content": prompt}],
            max_tokens=GROQ_MAX_TOKENS,
            temperature=0.6 # –ß—É—Ç—å –º–µ–Ω—å—à–µ –∫—Ä–µ–∞—Ç–∏–≤–∞, —á—Ç–æ–±—ã —Å–æ–±–ª—é–¥–∞–ª –ø—Ä–∞–≤–∏–ª–∞
        )
        return response.choices[0].message.content
    
    @staticmethod
    async def determine_intent(user_message: str, dish_list: str) -> Dict:
        # –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π
        prompt = f"""–ö–æ–Ω—Ç–µ–∫—Å—Ç (—Å–ø–∏—Å–æ–∫ –±–ª—é–¥): {dish_list}
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç: "{user_message}"

–ó–∞–¥–∞—á–∞: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏–µ.
1. –ï—Å–ª–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –±–ª—é–¥–æ -> "select_dish"
2. –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã -> "add_products"
3. –ù–µ–ø–æ–Ω—è—Ç–Ω–æ -> "unclear"

–í–µ—Ä–Ω–∏ JSON: {{"intent": "...", "dish_name": "...", "products": "..."}}"""

        response = await client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[{"role": "user", "content": prompt}],
            max_tokens=200,
            temperature=0.1
        )
        
        result = response.choices[0].message.content.strip()
        if result.startswith("```"):
            result = result.split("```")[1].strip()
            if result.startswith("json"):
                result = result[4:].strip()
        
        try:
            return json.loads(result)
        except:
            return {"intent": "unclear"}
            
    @staticmethod
    async def generate_recipe(dish_name: str, products: str) -> str:
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ü–µ–ø—Ç–∞
        prompt = f"""–ù–∞–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç: "{dish_name}".
        –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {products}.
        –ë–∞–∑–æ–≤—ã–µ (–≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å): –≤–æ–¥–∞, –º–∞—Å–ª–æ, —Å–æ–ª—å, –ø–µ—Ä–µ—Ü.
        
        –ï—Å–ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –±–ª—é–¥–∞ –±—ã–ª–æ —É–∫–∞–∑–∞–Ω–æ "(–¥–æ–∫—É–ø–∏—Ç—å: ...)", —É—á—Ç–∏ —ç—Ç–∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ —Å–æ—Å—Ç–∞–≤–µ.

        –§–æ—Ä–º–∞—Ç:
        üçΩÔ∏è [–ù–∞–∑–≤–∞–Ω–∏–µ]
        
        üõí –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:
        (–ü–æ–º–µ—Ç—å –≥–∞–ª–æ—á–∫–æ–π ‚úÖ —Ç–æ, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å, –∏ üõí —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å/–¥–æ–±–∞–≤–∏—Ç—å –∏–∑ –±–∞–∑–æ–≤—ã—Ö)

        üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:
        1. ...
        2. ...
        """

        response = await client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[{"role": "user", "content": prompt}],
            max_tokens=GROQ_MAX_TOKENS,
            temperature=0.7
        )
        return response.choices[0].message.content

    @staticmethod
    async def generate_freestyle_recipe(dish_name: str) -> str:
        prompt = f"""–ù–∞–ø–∏—à–∏ –∫–ª–∞—Å—Å–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –±–ª—é–¥–∞: "{dish_name}".
        –ü–∏—à–∏ —Å –¥—É—à–æ–π, –∫–∞–∫ —à–µ—Ñ-–ø–æ–≤–∞—Ä."""

        response = await client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[{"role": "user", "content": prompt}],
            max_tokens=GROQ_MAX_TOKENS,
            temperature=0.7
        )
        return response.choices[0].message.content
