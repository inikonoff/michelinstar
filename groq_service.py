from groq import AsyncGroq
from config import GROQ_API_KEY, GROQ_MODEL
from typing import Dict, List
import json
import re
import logging

client = AsyncGroq(api_key=GROQ_API_KEY)
logger = logging.getLogger(__name__)

class GroqService:
    
    @staticmethod
    async def _send_groq_request(system_prompt: str, user_text: str, temperature: float = 0.5, max_tokens: int = 1500) -> str:
        try:
            response = await client.chat.completions.create(
                model=GROQ_MODEL,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_text}
                ],
                max_tokens=max_tokens,
                temperature=temperature
            )
            return response.choices[0].message.content.strip()
        except Exception as e:
            logger.error(f"Groq API Error: {e}")
            return ""

    @staticmethod
    def _extract_json(text: str) -> str:
        text = text.replace("```json", "").replace("```", "")
        
        start_brace = text.find('{')
        start_bracket = text.find('[')
        
        if start_brace == -1:
            start = start_bracket
        elif start_bracket == -1:
            start = start_brace
        else:
            start = min(start_brace, start_bracket)
        
        end_brace = text.rfind('}')
        end_bracket = text.rfind(']')
        end = max(end_brace, end_bracket)
        
        if start != -1 and end != -1 and end > start:
            return text[start:end+1]
        
        return text.strip()

    # --- –ü–†–ê–í–ò–õ–ê –°–û–ß–ï–¢–ê–ï–ú–û–°–¢–ò (–∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞) ---
    FLAVOR_RULES = """‚ùóÔ∏è –ü–†–ê–í–ò–õ–ê –°–û–ß–ï–¢–ê–ï–ú–û–°–¢–ò:

üé≠ –ö–û–ù–¢–†–ê–°–¢–´ (—Å–æ–∑–¥–∞—é—Ç –∏–Ω—Ç–µ—Ä–µ—Å):
‚Ä¢ –ñ–∏—Ä–Ω–æ–µ + –ö–∏—Å–ª–æ–µ (—Å–≤–∏–Ω–∏–Ω–∞ + –∫–≤–∞—à–µ–Ω–∞—è –∫–∞–ø—É—Å—Ç–∞)
‚Ä¢ –°–ª–∞–¥–∫–æ–µ + –°–æ–ª—ë–Ω–æ–µ (–∞—Ä–±—É–∑ + –±—Ä—ã–Ω–∑–∞)
‚Ä¢ –ú—è–≥–∫–æ–µ + –•—Ä—É—Å—Ç—è—â–µ–µ (–∫—Ä–µ–º-—Å—É–ø + –≥—Ä–µ–Ω–∫–∏)

‚ú® –£–°–ò–õ–ï–ù–ò–ï (—Å—Ö–æ–∂–∏–µ –≤–∫—É—Å—ã):
‚Ä¢ –ü–æ–º–∏–¥–æ—Ä + –ë–∞–∑–∏–ª–∏–∫
‚Ä¢ –†—ã–±–∞ + –£–∫—Ä–æ–ø + –õ–∏–º–æ–Ω
‚Ä¢ –¢—ã–∫–≤–∞ + –ö–æ—Ä–∏—Ü–∞

üëë –û–î–ò–ù –ì–õ–ê–í–ù–´–ô –ò–ù–ì–†–ï–î–ò–ï–ù–¢:
–í –∫–∞–∂–¥–æ–º –±–ª—é–¥–µ ‚Äî –æ–¥–∏–Ω "–∫–æ—Ä–æ–ª—å", –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî "—Å–≤–∏—Ç–∞"

‚úÖ –ü–†–û–í–ï–†–ï–ù–ù–´–ï –ü–ê–†–´:
‚Ä¢ –ü–æ–º–∏–¥–æ—Ä + –ë–∞–∑–∏–ª–∏–∫ + –ß–µ—Å–Ω–æ–∫
‚Ä¢ –ë–∞—Ä–∞–Ω–∏–Ω–∞ + –†–æ–∑–º–∞—Ä–∏–Ω/–ú—è—Ç–∞
‚Ä¢ –°—ã—Ä + –û—Ä–µ—Ö–∏/–ú—ë–¥

‚ùå –ö–£–õ–ò–ù–ê–†–ù–´–ï –¢–ê–ë–£:
‚Ä¢ –†—ã–±–∞ üêü + –ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã ü•õ (–≤ –≥–æ—Ä—è—á–∏—Ö –±–ª—é–¥–∞—Ö)
‚Ä¢ –î–≤–∞ —Å–∏–ª—å–Ω—ã—Ö –º—è—Å–∞ ü•©+üçó –≤ –æ–¥–Ω–æ–π –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
"""

    @staticmethod
    async def validate_ingredients(text: str) -> bool:
        prompt = """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—Å—Ç –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å.

üìã –ö–†–ò–¢–ï–†–ò–ò –í–ê–õ–ò–î–ù–û–°–¢–ò:
‚úÖ –ü–†–ò–ù–Ø–¢–¨ –µ—Å–ª–∏:
- –°—ä–µ–¥–æ–±–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–º—è—Å–æ, –æ–≤–æ—â–∏, –∫—Ä—É–ø—ã, –º–æ–ª–æ–∫–æ –∏ —Ç.–¥.)
- –î–æ–ø—É—Å—Ç–∏–º—ã –æ–ø–µ—á–∞—Ç–∫–∏ ("–∫–∞—Ä—Ä—Ç–æ—Ñ–µ–ª—å", "–º–æ–ª–∫–æ")
- –î–æ–ø—É—Å—Ç–∏–º—ã –æ–±—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ("–∑–µ–ª–µ–Ω—å", "—Å–ø–µ—Ü–∏–∏")

‚ùå –û–¢–ö–õ–û–ù–ò–¢–¨ –µ—Å–ª–∏:
- –ù–µ—Å—ä–µ–¥–æ–±–Ω–æ–µ (–±–µ–Ω–∑–∏–Ω, —Å—Ç–µ–∫–ª–æ, —Ö–∏–º–∏–∫–∞—Ç—ã)
- –†—É–≥–∞—Ç–µ–ª—å—Å—Ç–≤–∞, –∂–∞—Ä–≥–æ–Ω –∏ –º–∞—Ç (–∂–æ–ø–∞, —Ç–≤–∞—Ä—å, –±–ª—è–¥—å, —Ö—É–π)
- –ë–µ—Å—Å–º—ã—Å–ª–∏—Ü–∞ ("–∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–∞", "—Ñ—ã–≤–∞ –æ–ª–¥–∂")
- –¢–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è ("–ø—Ä–∏–≤–µ—Ç", "hello")
- –ü—É—Å—Ç–æ–π –≤–≤–æ–¥ –∏–ª–∏ <3 —Å–∏–º–≤–æ–ª–æ–≤

üéØ –°–¢–†–û–ì–ò–ô –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
{"valid": true, "reason": "–∫—Ä–∞—Ç–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞"}
–∏–ª–∏
{"valid": false, "reason": "–∫—Ä–∞—Ç–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞"}

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å "{" –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è "}"
–ù–ï –¥–æ–±–∞–≤–ª—è–π:
- –í–≤–æ–¥–Ω—ã–µ —Ñ—Ä–∞–∑—ã ("–í–æ—Ç JSON:", "–ö–æ–Ω–µ—á–Ω–æ!")
- Markdown (```json```)
- –ü–æ—è—Å–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ JSON

–ü–ï–†–í–´–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "{"
–ü–û–°–õ–ï–î–ù–ò–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "}"
"""
        
        res = await GroqService._send_groq_request(prompt, f'üìù –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º—ã–π —Ç–µ–∫—Å—Ç: "{text}"', 0.1)
        
        try:
            clean_json = GroqService._extract_json(res)
            data = json.loads(clean_json)
            return data.get("valid", False)
        except Exception as e:
            logger.error(f"Validation JSON Error: {e}, Response: {res}")
            return "true" in res.lower()

    @staticmethod
    async def analyze_categories(products: str) -> List[str]:
        items_count = len(re.split(r'[,;]', products))
        
        if items_count >= 8:
            mix_type = "full"
            mix_available = True
            mix_rule = """- "mix" (–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –æ–±–µ–¥: –°—É–ø + –í—Ç–æ—Ä–æ–µ + –ù–∞–ø–∏—Ç–æ–∫/–°–∞–ª–∞—Ç)
‚ö†Ô∏è "mix" –¥–æ—Å—Ç—É–ø–µ–Ω –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚â•8 (–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å–µ—Ç –∏–∑ 3 –±–ª—é–¥)"""
        elif items_count >= 5:
            mix_type = "light"
            mix_available = True
            mix_rule = """- "mix" (–ª—ë–≥–∫–∏–π –æ–±–µ–¥: 2 —Å–æ—á–µ—Ç–∞—é—â–∏—Ö—Å—è –±–ª—é–¥–∞)
‚ö†Ô∏è "mix" –¥–æ—Å—Ç—É–ø–µ–Ω –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚â•5 (–ª—ë–≥–∫–∏–π —Å–µ—Ç –∏–∑ 2 –±–ª—é–¥)"""
        else:
            mix_available = False
            mix_rule = """‚ö†Ô∏è "mix" –ù–ï–î–û–°–¢–£–ü–ï–ù (–ø—Ä–æ–¥—É–∫—Ç–æ–≤ <5)"""
        
        prompt = f"""–¢—ã –æ–ø—ã—Ç–Ω—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä. –û–ø—Ä–µ–¥–µ–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª—é–¥, –∫–æ—Ç–æ—Ä—ã–µ –†–ï–ê–õ–¨–ù–û –º–æ–∂–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å.

üõí –ü–†–û–î–£–ö–¢–´: {products}
üì¶ –ë–ê–ó–ê (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞): —Å–æ–ª—å, —Å–∞—Ö–∞—Ä, –≤–æ–¥–∞, –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ –º–∞—Å–ª–æ, —Å–ø–µ—Ü–∏–∏, –ª—ë–¥

üìö –ö–ê–¢–ï–ì–û–†–ò–ò:
- "soup" (—Å—É–ø—ã ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Å–Ω–æ–≤–∞ –¥–ª—è –±—É–ª—å–æ–Ω–∞)
- "main" (–≤—Ç–æ—Ä—ã–µ –±–ª—é–¥–∞ ‚Äî –º—è—Å–æ/—Ä—ã–±–∞/–∫—Ä—É–ø—ã)
- "salad" (—Å–∞–ª–∞—Ç—ã ‚Äî –æ–≤–æ—â–∏/–∑–µ–ª–µ–Ω—å)
- "breakfast" (–∑–∞–≤—Ç—Ä–∞–∫–∏ ‚Äî —è–π—Ü–∞/–º–æ–ª–æ–∫–æ/—Ö–ª–µ–±)
- "dessert" (–¥–µ—Å–µ—Ä—Ç—ã ‚Äî —Å–∞—Ö–∞—Ä + —Ñ—Ä—É–∫—Ç—ã/–º–æ–ª–æ–∫–æ)
- "drink" (–Ω–∞–ø–∏—Ç–∫–∏ ‚Äî —Ñ—Ä—É–∫—Ç—ã/–º–æ–ª–æ–∫–æ/—á–∞–π)
- "snack" (–∑–∞–∫—É—Å–∫–∏ ‚Äî –±—ã—Å—Ç—Ä—ã–µ –±–ª—é–¥–∞)
{mix_rule}

‚ö†Ô∏è –ü–†–ê–í–ò–õ–ê:
1. –í–æ–∑–≤—Ä–∞—â–∞–π 2-4 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–µ –≤—Å–µ —Å—Ä–∞–∑—É!)
2. –ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ‚Äî –≤—ã–±–µ—Ä–∏ —Å–∞–º—ã–µ –æ—á–µ–≤–∏–¥–Ω—ã–µ
3. –ù–µ –¥–æ–±–∞–≤–ª—è–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π" ‚Äî —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ

üìñ –ü–†–ò–ú–ï–†–´ (—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ):
–ü—Ä–æ–¥—É–∫—Ç—ã: "–∫—É—Ä–∏—Ü–∞, —Ä–∏—Å" ‚Üí ["main"]
–ü—Ä–æ–¥—É–∫—Ç—ã: "–∫—É—Ä–∏—Ü–∞, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –º–æ—Ä–∫–æ–≤—å, –ª—É–∫, —Ä–∏—Å" ‚Üí ["soup", "main", "mix"]
–ü—Ä–æ–¥—É–∫—Ç—ã: "–≥–æ–≤—è–¥–∏–Ω–∞, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –º–æ—Ä–∫–æ–≤—å, –ª—É–∫, –∫–∞–ø—É—Å—Ç–∞, —Ä–∏—Å, –ø–æ–º–∏–¥–æ—Ä—ã, —è–±–ª–æ–∫–∏" ‚Üí ["soup", "main", "salad", "drink", "mix"]

üéØ –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–¢–û–õ–¨–ö–û JSON):
["–∫–∞—Ç–µ–≥–æ—Ä–∏—è1", "–∫–∞—Ç–µ–≥–æ—Ä–∏—è2", "–∫–∞—Ç–µ–≥–æ—Ä–∏—è3"]

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
–ü–ï–†–í–´–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "["
–ü–û–°–õ–ï–î–ù–ò–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "]"
–ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –¥–æ/–ø–æ—Å–ª–µ JSON!
"""
        
        res = await GroqService._send_groq_request(prompt, "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", 0.2)
        
        try:
            clean_json = GroqService._extract_json(res)
            data = json.loads(clean_json)
            if isinstance(data, list):
                if "mix" in data and not mix_available:
                    data.remove("mix")
                    logger.warning(f"Removed 'mix' category: not enough products ({items_count} < 5)")
                return data
        except Exception as e:
            logger.error(f"Categories JSON Error: {e}, Response: {res}")
        
        return ["main"]

    @staticmethod
    async def generate_dishes_list(products: str, category: str) -> List[Dict[str, str]]:
        items_count = len(re.split(r'[,]', products))
        
        if category == "mix":
            if items_count >= 8:
                target_count = 4
                dishes_per_set = 3
                mix_type_desc = "–ü–û–õ–ù–û–¶–ï–ù–ù–´–ô –û–ë–ï–î (3 –±–ª—é–¥–∞): –°—É–ø + –í—Ç–æ—Ä–æ–µ + –ù–∞–ø–∏—Ç–æ–∫/–°–∞–ª–∞—Ç"
                combinations = "- –°—É–ø + –í—Ç–æ—Ä–æ–µ + –ù–∞–ø–∏—Ç–æ–∫\n- –°—É–ø + –í—Ç–æ—Ä–æ–µ + –°–∞–ª–∞—Ç\n- –°—É–ø + –°–∞–ª–∞—Ç + –ù–∞–ø–∏—Ç–æ–∫"
            elif items_count >= 5:
                target_count = 5
                dishes_per_set = 2
                mix_type_desc = "–õ–Å–ì–ö–ò–ô –û–ë–ï–î (2 –±–ª—é–¥–∞)"
                combinations = "- –°—É–ø + –í—Ç–æ—Ä–æ–µ\n- –í—Ç–æ—Ä–æ–µ + –°–∞–ª–∞—Ç\n- –í—Ç–æ—Ä–æ–µ + –ù–∞–ø–∏—Ç–æ–∫\n- –°—É–ø + –°–∞–ª–∞—Ç"
            else:
                return []
            
            mix_specific = f"""
üç± {mix_type_desc}

üîπ –í–û–ó–ú–û–ñ–ù–´–ï –ö–û–ú–ë–ò–ù–ê–¶–ò–ò ({dishes_per_set} –±–ª—é–¥–∞):
{combinations}

üîπ –†–ï–ê–õ–ò–°–¢–ò–ß–ù–û–ï –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï:
‚Ä¢ –ú—è—Å–æ/—Ä—ã–±–∞: –∏—Å–ø–æ–ª—å–∑—É–π –≤ 1-2 –±–ª—é–¥–∞—Ö (–Ω–µ –≤–æ –≤—Å–µ—Ö!)
‚Ä¢ –û–≤–æ—â–∏: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–π –ª–æ–≥–∏—á–Ω–æ –º–µ–∂–¥—É –±–ª—é–¥–∞–º–∏
‚Ä¢ –ë–∞–∑–∞ (—Å–æ–ª—å, –º–∞—Å–ª–æ, –≤–æ–¥–∞): –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è –≤ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö

{GroqService.FLAVOR_RULES}

üîπ –õ–û–ì–ò–ö–ê –°–û–ß–ï–¢–ê–ù–ò–ô –î–õ–Ø –°–ï–¢–û–í:
‚Ä¢ –†—ã–±–Ω—ã–π –¥–µ–Ω—å: —Ä—ã–±–Ω—ã–π —Å—É–ø ‚Üí —Ä—ã–±–Ω–æ–µ –≤—Ç–æ—Ä–æ–µ
‚Ä¢ –ú—è—Å–Ω–æ–π –¥–µ–Ω—å: –º—è—Å–Ω–æ–π —Å—É–ø ‚Üí –º—è—Å–Ω–æ–µ –≤—Ç–æ—Ä–æ–µ
‚Ä¢ –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å: —É—á–∏—Ç—ã–≤–∞–π –≤—Ä–µ–º—è –≥–æ–¥–∞
‚Ä¢ –ö–æ–Ω—Ç—Ä–∞—Å—Ç —Ç–µ–∫—Å—Ç—É—Ä: –º—è–≥–∫–æ–µ + —Ö—Ä—É—Å—Ç—è—â–µ–µ –≤ —Ä–∞–∑–Ω—ã—Ö –±–ª—é–¥–∞—Ö

‚ùå –ù–ï–õ–¨–ó–Ø –í –°–ï–¢–ï:
‚Ä¢ –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –≤–æ –í–°–ï–• –±–ª—é–¥–∞—Ö
‚Ä¢ –î–µ–ª–∞—Ç—å –¥–≤–∞ —Å—É–ø–∞ –∏–ª–∏ –¥–≤–∞ –≤—Ç–æ—Ä—ã—Ö –≤ –æ–¥–Ω–æ–º —Å–µ—Ç–µ
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –í–°–ï –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –æ–¥–Ω–æ–º –±–ª—é–¥–µ
‚Ä¢ –ù–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Å–æ—á–µ—Ç–∞–µ–º–æ—Å—Ç–∏ (—Å–º. –≤—ã—à–µ)
"""
            
            prompt = f"""üìù –ó–ê–î–ê–ù–ò–ï: –°–æ—Å—Ç–∞–≤—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –ö–û–ú–ü–õ–ï–ö–°–ù–´–• –û–ë–ï–î–û–í (—Å–µ—Ç–æ–≤).

üõí –ü–†–û–î–£–ö–¢–´: {products}
üì¶ –ë–ê–ó–ê: —Å–æ–ª—å, —Å–∞—Ö–∞—Ä, –≤–æ–¥–∞, –º–∞—Å–ª–æ, —Å–ø–µ—Ü–∏–∏

üéØ –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö –æ–±–µ–¥–æ–≤: –°–¢–†–û–ì–û {target_count}
- –ö–∞–∂–¥—ã–π –æ–±–µ–¥ = {dishes_per_set} —Å–æ—á–µ—Ç–∞—é—â–∏—Ö—Å—è –±–ª—é–¥–∞
- –°–õ–ï–î–£–ô –ü–†–ê–í–ò–õ–ê–ú –°–û–ß–ï–¢–ê–ï–ú–û–°–¢–ò (—Å–º. –Ω–∏–∂–µ)
- –ù–∞–∑–≤–∞–Ω–∏–µ: "–û–±–µ–¥ ‚ÑñX: [–ë–ª—é–¥–æ] + [–ë–ª—é–¥–æ]" (–¥–ª—è 3 –±–ª—é–¥: "... + [–ë–ª—é–¥–æ] + [–ë–ª—é–¥–æ]")
- –û–ø–∏—Å–∞–Ω–∏–µ: –ü–µ—Ä–µ—á–∏—Å–ª–∏ –í–°–ï –±–ª—é–¥–∞ –≤ —Å–µ—Ç–µ –∏ –∏—Ö –∫—Ä–∞—Ç–∫–∏–π —Å–æ—Å—Ç–∞–≤
{mix_specific}

üìñ –ü–†–ò–ú–ï–† –§–û–†–ú–ê–¢–ê –î–õ–Ø {dishes_per_set} –ë–õ–Æ–î:
[
  {{
    "name": "–û–±–µ–¥ ‚Ññ1: –ö—É—Ä–∏–Ω—ã–π —Å—É–ø + –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å–Ω–æ–µ –ø—é—Ä–µ —Å –∫–æ—Ç–ª–µ—Ç–æ–π"{" + –ö–æ–º–ø–æ—Ç –∏–∑ —è–±–ª–æ–∫" if dishes_per_set == 3 else ""},
    "desc": "–ö—É—Ä–∏–Ω—ã–π —Å—É–ø —Å –≤–µ—Ä–º–∏—à–µ–ª—å—é –∏ –º–æ—Ä–∫–æ–≤—å—é. –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å–Ω–æ–µ –ø—é—Ä–µ —Å –∫—É—Ä–∏–Ω–æ–π –∫–æ—Ç–ª–µ—Ç–æ–π.{" –ö–æ–º–ø–æ—Ç –∏–∑ —Å–≤–µ–∂–∏—Ö —è–±–ª–æ–∫." if dishes_per_set == 3 else ""}"
  }}
]

üö® –í–ê–ñ–ù–û: –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ ‚Äî —ç—Ç–æ –¶–ï–õ–´–ô –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –û–ë–ï–î (—Å–µ—Ç), –∞ –Ω–µ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –±–ª—é–¥–æ!
"""
        
        else:
            if items_count <= 3:
                target_count = 4
            elif items_count <= 6:
                target_count = 5
            elif items_count <= 10:
                target_count = 6
            else:
                target_count = 7

            cat_names = {
                "soup": "–°—É–ø—ã", "main": "–í—Ç–æ—Ä—ã–µ –±–ª—é–¥–∞", "salad": "–°–∞–ª–∞—Ç—ã", 
                "breakfast": "–ó–∞–≤—Ç—Ä–∞–∫–∏", "dessert": "–î–µ—Å–µ—Ä—Ç—ã", "drink": "–ù–∞–ø–∏—Ç–∫–∏", 
                "snack": "–ó–∞–∫—É—Å–∫–∏", "mix": "–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –æ–±–µ–¥—ã"
            }
            cat_ru = cat_names.get(category, "–ë–ª—é–¥–∞")
            
            prompt = f"""üìù –ó–ê–î–ê–ù–ò–ï: –°–æ—Å—Ç–∞–≤—å –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "{cat_ru}".

üõí –ü–†–û–î–£–ö–¢–´: {products}
üì¶ –ë–ê–ó–ê: —Å–æ–ª—å, —Å–∞—Ö–∞—Ä, –≤–æ–¥–∞, –º–∞—Å–ª–æ, —Å–ø–µ—Ü–∏–∏

{GroqService.FLAVOR_RULES}

üéØ –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª—é–¥: –°–¢–†–û–ì–û {target_count} (–Ω–µ –±–æ–ª—å—à–µ, –Ω–µ –º–µ–Ω—å—à–µ!)
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞ + –±–∞–∑–∞
- –°–õ–ï–î–£–ô –ü–†–ê–í–ò–õ–ê–ú –°–û–ß–ï–¢–ê–ï–ú–û–°–¢–ò (—Å–º. –≤—ã—à–µ)
- –ù–∞–∑–≤–∞–Ω–∏—è ‚Äî –∞–ø–ø–µ—Ç–∏—Ç–Ω—ã–µ, –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
- –û–ø–∏—Å–∞–Ω–∏—è ‚Äî 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –≤—ã–∑—ã–≤–∞—é—Ç –∞–ø–ø–µ—Ç–∏—Ç

üìñ –ü–†–ò–ú–ï–† –§–û–†–ú–ê–¢–ê:
[
  {{
    "name": "–ö—É—Ä–∏–Ω—ã–π —Å—É–ø —Å –ª–∞–ø—à–æ–π",
    "desc": "–ê—Ä–æ–º–∞—Ç–Ω—ã–π –±—É–ª—å–æ–Ω —Å –Ω–µ–∂–Ω–æ–π –∫—É—Ä–∏—Ü–µ–π –∏ –¥–æ–º–∞—à–Ω–µ–π –ª–∞–ø—à–æ–π. –°–æ–≥—Ä–µ–≤–∞–µ—Ç –≤ —Ö–æ–ª–æ–¥–Ω—ã–π –¥–µ–Ω—å."
  }}
]

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
–ü–ï–†–í–´–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "["
–ü–û–°–õ–ï–î–ù–ò–ô —Å–∏–º–≤–æ–ª –æ—Ç–≤–µ—Ç–∞ = "]"
–°–¢–†–û–ì–ò–ô JSON! –ë–ï–ó –¢–ï–ö–°–¢–ê –î–û/–ü–û–°–õ–ï!
"""
        
        res = await GroqService._send_groq_request(prompt, "–ì–µ–Ω–µ—Ä–∏—Ä—É–π –º–µ–Ω—é", 0.5)
        
        try:
            clean_json = GroqService._extract_json(res)
            data = json.loads(clean_json)
            if isinstance(data, list):
                return data
        except json.JSONDecodeError as e:
            logger.error(f"JSON decode error: {e}, Response: {clean_json[:200]}...")
        except Exception as e:
            logger.error(f"Dishes JSON Error: {e}, Response: {res[:200]}...")
        
        return []

    @staticmethod
    async def generate_recipe(dish_name: str, products: str) -> str:
        is_mix = any(x in dish_name.lower() for x in ["–æ–±–µ–¥", "—Å–µ—Ç", "–∫–æ–º–ø–ª–µ–∫—Å", "‚Ññ", "+"])
        
        if is_mix:
            if dish_name.count("+") >= 2:
                dishes_in_set = 3
            else:
                dishes_in_set = 2
            
            mix_instruction = f"""
üç± –≠–¢–û –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –û–ë–ï–î –ò–ó {dishes_in_set} –ë–õ–Æ–î:

{GroqService.FLAVOR_RULES}

üîπ –¢–†–ï–ë–û–í–ê–ù–ò–Ø –î–õ–Ø –°–ï–¢–ê:
1. –ü—Ä–∏–≤–µ–¥–∏ —Ä–µ—Ü–µ–ø—Ç—ã –í–°–ï–• {dishes_in_set} –±–ª—é–¥, –≤—Ö–æ–¥—è—â–∏—Ö –≤ —Å–µ—Ç
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª—é–¥–∞ —É–∫–∞–∂–∏ –û–¢–î–ï–õ–¨–ù–´–ï –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏ —à–∞–≥–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
3. –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª—é–¥–∞: "[–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ 1]", "[–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ 2]"
4. –†–∞—Å—Å—á–∏—Ç–∞–π –ö–ë–ñ–£ –¥–ª—è –í–°–ï–ì–û –û–ë–ï–î–ê (—Å—É–º–º–∞ –≤—Å–µ—Ö –±–ª—é–¥)
5. –û–±—â–µ–µ –≤—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è = —Å—É–º–º–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—Å–µ—Ö –±–ª—é–¥
6. –°–û–ë–õ–Æ–î–ê–ô –ü–†–ê–í–ò–õ–ê –°–û–ß–ï–¢–ê–ï–ú–û–°–¢–ò –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤

üîπ –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–†–û–î–£–ö–¢–û–í:
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –ª–æ–≥–∏—á–Ω–æ –º–µ–∂–¥—É –±–ª—é–¥–∞–º–∏, —Å–ª–µ–¥—É—è –ø—Ä–∞–≤–∏–ª–∞–º —Å–æ—á–µ—Ç–∞–µ–º–æ—Å—Ç–∏
- –ù–µ –¥—É–±–ª–∏—Ä—É–π –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç (–º—è—Å–æ/—Ä—ã–±—É) –≤–æ –≤—Å–µ—Ö –±–ª—é–¥–∞—Ö
- –°–æ–∑–¥–∞–π –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π –≤–∫—É—Å–æ–≤–æ–π –∞–Ω—Å–∞–º–±–ª—å
"""
        else:
            mix_instruction = f"""
{GroqService.FLAVOR_RULES}

üîπ –°–û–ë–õ–Æ–î–ê–ô –ü–†–ê–í–ò–õ–ê –°–û–ß–ï–¢–ê–ï–ú–û–°–¢–ò –ø—Ä–∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ —Ä–µ—Ü–µ–ø—Ç–∞:
- –£—á–∏—Ç—ã–≤–∞–π –±–∞–ª–∞–Ω—Å –≤–∫—É—Å–æ–≤ (–∫–æ–Ω—Ç—Ä–∞—Å—Ç—ã –∏ —É—Å–∏–ª–µ–Ω–∏–µ)
- –û–ø—Ä–µ–¥–µ–ª–∏ –æ–¥–∏–Ω –≥–ª–∞–≤–Ω—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
- –ò–∑–±–µ–≥–∞–π –∫—É–ª–∏–Ω–∞—Ä–Ω—ã—Ö —Ç–∞–±—É
"""
        
        prompt = f"""–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —à–µ—Ñ. –ù–∞–ø–∏—à–∏ —Ä–µ—Ü–µ–ø—Ç: "{dish_name}".

üõí –ü–†–û–î–£–ö–¢–´: {products}
üì¶ –ë–ê–ó–ê (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞): —Å–æ–ª—å, —Å–∞—Ö–∞—Ä, –≤–æ–¥–∞, –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ –º–∞—Å–ª–æ, —Å–ø–µ—Ü–∏–∏
{mix_instruction}

üìã –°–¢–†–û–ì–ò–ô –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:

[–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ –∏–ª–∏ —Å–µ—Ç–∞]

üì¶ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:
- [–ø—Ä–æ–¥—É–∫—Ç] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ]
- [–ø—Ä–æ–¥—É–∫—Ç] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ]
{"(–î–ª—è —Å–µ—Ç–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª—é–¥–∞ –ø–æ–¥ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏)" if is_mix else ""}

üìä –ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ 1 –ø–æ—Ä—Ü–∏—é (–ø—Ä–∏–º–µ—Ä–Ω–æ):
ü•ö –ë–µ–ª–∫–∏: X –≥
ü•ë –ñ–∏—Ä—ã: X –≥  
üåæ –£–≥–ª–µ–≤–æ–¥—ã: X –≥
‚ö° –≠–Ω–µ—Ä–≥. —Ü–µ–Ω–Ω–æ—Å—Ç—å: X –∫–∫–∞–ª
{"(–î–ª—è —Å–µ—Ç–∞ ‚Äî –æ–±—â–∞—è –ø–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –í–°–ï–ì–û –æ–±–µ–¥–∞)" if is_mix else ""}

‚è± –í—Ä–µ–º—è: X –º–∏–Ω—É—Ç
{"(–î–ª—è —Å–µ—Ç–∞ ‚Äî –æ–±—â–µ–µ –≤—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –±–ª—é–¥)" if is_mix else ""}
üéö –°–ª–æ–∂–Ω–æ—Å—Ç—å: [–Ω–∏–∑–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–≤—ã—Å–æ–∫–∞—è]
üë• –ü–æ—Ä—Ü–∏–∏: X —á–µ–ª.

üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:
1. [–ø–æ–¥—Ä–æ–±–Ω—ã–π —à–∞–≥]
2. [–ø–æ–¥—Ä–æ–±–Ω—ã–π —à–∞–≥]
3. [–ø–æ–¥—Ä–æ–±–Ω—ã–π —à–∞–≥]
{"(–î–ª—è —Å–µ—Ç–∞ ‚Äî –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –í–°–ï–• –±–ª—é–¥)" if is_mix else ""}

üí° –°–û–í–ï–¢ –®–ï–§-–ü–û–í–ê–†–ê: [Analyze Taste, Aroma and Texture. Recommend ONE missing item for balance].
"""

        res = await GroqService._send_groq_request(prompt, "–ù–∞–ø–∏—à–∏ —Ä–µ—Ü–µ–ø—Ç", 0.4, max_tokens=2500)
        
        if GroqService._is_refusal(res): 
            return res
        
        return res + "\n\nüë®‚Äçüç≥ <b>–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!</b>"

    @staticmethod
    async def generate_freestyle_recipe(dish_name: str) -> str:
        prompt = f"""–¢—ã –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä –∏ —Ñ–∏–ª–æ—Å–æ—Ñ –∫—É—Ö–Ω–∏. –°–æ–∑–¥–∞–π —Ä–µ—Ü–µ–ø—Ç: "{dish_name}"

üîç –ê–ù–ê–õ–ò–ó –ó–ê–ü–†–û–°–ê:
–ï—Å–ª–∏ —ç—Ç–æ –ï–î–ê (–ø–∏—Ü—Ü–∞, –±–æ—Ä—â, —Ç–æ—Ä—Ç) ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç —Å –ö–ë–ñ–£
–ï—Å–ª–∏ —ç—Ç–æ –ú–ï–¢–ê–§–û–†–ê (—Å—á–∞—Å—Ç—å–µ, —É—Å–ø–µ—Ö, –ª—é–±–æ–≤—å) ‚Üí —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π —Ä–µ—Ü–µ–ø—Ç-–∞–ª–ª–µ–≥–æ—Ä–∏—è

üìã –§–û–†–ú–ê–¢ –î–õ–Ø –ï–î–´:

[–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞]

üì¶ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:
- [–ø—Ä–æ–¥—É–∫—Ç] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ]

üìä –ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å (–ø—Ä–∏–º–µ—Ä–Ω–æ):
ü•ö –ë–µ–ª–∫–∏: X –≥.
ü•ë –ñ–∏—Ä—ã: X –≥.
üåæ –£–≥–ª–µ–≤–æ–¥—ã: X –≥.
‚ö° –ö–∞–ª–æ—Ä–∏–∏: X –∫–∫–∞–ª.

‚è± –í—Ä–µ–º—è: X –º–∏–Ω.
üéö –°–ª–æ–∂–Ω–æ—Å—Ç—å: [–Ω–∏–∑–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–≤—ã—Å–æ–∫–∞—è]
üë• –ü–æ—Ä—Ü–∏–π: X

üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:
1. [—à–∞–≥]
2. [—à–∞–≥]

üí° –°–û–í–ï–¢ –®–ï–§–ê: [Analyze Taste, Aroma and Texture. Recommend ONE missing item for balance]

---

üìã –§–û–†–ú–ê–¢ –î–õ–Ø –ú–ï–¢–ê–§–û–†–´:

üé≠ –†–µ—Ü–µ–ø—Ç "{dish_name}"

üì¶ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (—Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ):
- [–∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–µ –ø–æ–Ω—è—Ç–∏–µ] ‚Äî [–º–µ—Ç–∞—Ñ–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞]
–ü—Ä–∏–º–µ—Ä: "3 —á–∞—à–∫–∏ —Ç–µ—Ä–ø–µ–Ω–∏—è", "—â–µ–ø–æ—Ç–∫–∞ —é–º–æ—Ä–∞"

üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ (—Ñ–∏–ª–æ—Å–æ—Ñ–∏—è):
1. [–º—É–¥—Ä—ã–π —Å–æ–≤–µ—Ç –≤ —Å—Ç–∏–ª–µ –∫—É–ª–∏–Ω–∞—Ä–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏]
2. [–µ—â—ë —Å–æ–≤–µ—Ç]

‚è± –í—Ä–µ–º—è —Å–æ–∑—Ä–µ–≤–∞–Ω–∏—è: [–º–µ—Ç–∞—Ñ–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏]
–ü—Ä–∏–º–µ—Ä: "–í—Å—é –∂–∏–∑–Ω—å" –∏–ª–∏ "21 –¥–µ–Ω—å –ø—Ä–∏–≤—ã—á–∫–∏"

üí° –°–ï–ö–†–ï–¢ –ë–õ–Æ–î–ê: [–≥–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å –æ–¥–Ω–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º]

‚ö†Ô∏è –ù–ï —Å–º–µ—à–∏–≤–∞–π —Ñ–æ—Ä–º–∞—Ç—ã! –õ–∏–±–æ —Ä–µ–∞–ª—å–Ω–∞—è –µ–¥–∞, –ª–∏–±–æ –º–µ—Ç–∞—Ñ–æ—Ä–∞.
–î–ª—è –º–µ—Ç–∞—Ñ–æ—Ä –∏—Å–ø–æ–ª—å–∑—É–π –∫—É–ª–∏–Ω–∞—Ä–Ω—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é (–ø–µ—Ä–µ–º–µ—à–∞–π, –¥–∞–π –Ω–∞—Å—Ç–æ—è—Ç—å—Å—è, –ø–æ–¥–∞–≤–∞–π —Ç—ë–ø–ª—ã–º).
"""
        
        res = await GroqService._send_groq_request(prompt, "–°–æ–∑–¥–∞–π —Ä–µ—Ü–µ–ø—Ç", 0.6, max_tokens=2000)
        
        if GroqService._is_refusal(res):
            return res
        
        return res + "\n\nüë®‚Äçüç≥ <b>–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!</b>"

    @staticmethod
    def _is_refusal(text: str) -> bool:
        if "‚õî" in text:
            return True
        refusals = ["cannot fulfill", "cannot answer", "against my policy", "–Ω–µ –º–æ–≥—É –≤—ã–ø–æ–ª–Ω–∏—Ç—å"]
        return any(ph in text.lower() for ph in refusals)