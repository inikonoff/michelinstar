from groq import AsyncGroq
from config import GROQ_API_KEY, GROQ_MODEL, GROQ_MAX_TOKENS
from typing import Dict, List, Union
import json
import re
import logging

client = AsyncGroq(api_key=GROQ_API_KEY)
logger = logging.getLogger(__name__)

class GroqService:
    
    # --- –ë–ê–ó–û–í–´–ô –ú–ï–¢–û–î –ó–ê–ü–†–û–°–ê ---
    @staticmethod
    async def _send_groq_request(
        system_prompt: str, 
        user_text: str, 
        temperature: float = 0.5, 
        max_tokens: int = 1000
    ) -> str:
        """–ë–∞–∑–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Groq API"""
        try:
            response = await client.chat.completions.create(
                model=GROQ_MODEL,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_text}
                ],
                max_tokens=max_tokens,
                temperature=temperature
            )
            return response.choices[0].message.content.strip()
        except Exception as e:
            logger.error(f"Groq API Error: {e}")
            return ""

    # --- –õ–û–ì–ò–ö–ê ---

    @staticmethod
    async def validate_ingredients(text: str) -> bool:
        """üîç –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤"""
        prompt = """üçÖ –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –º–æ–¥–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.
        
        üìã –í–µ—Ä–Ω–∏ JSON: {"valid": true} –ï–°–õ–ò –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Å—ä–µ–¥–æ–±–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã/–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã.
        üö´ –í–µ—Ä–Ω–∏ JSON: {"valid": false} –ï–°–õ–ò:
          - –ë–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
          - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è/–æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã
          - –ù–µ—Å—ä–µ–¥–æ–±–Ω—ã–µ/–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
          - –ù–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –µ–¥–æ–π –∑–∞–ø—Ä–æ—Å—ã
        
        ‚ö†Ô∏è –í–ï–†–ù–ò –¢–û–õ–¨–ö–û JSON –ë–ï–ó –õ–ò–®–ù–ò–• –°–õ–û–í!"""
        
        res = await GroqService._send_groq_request(prompt, f"–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π: \"{text}\"", 0.1)
        return "true" in res.lower()

    @staticmethod
    async def analyze_categories(products: str) -> List[str]:
        """
        üçΩÔ∏è –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª—é–¥ –º–æ–∂–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –∏–∑ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π:
        ['soup', 'main', 'salad', 'dessert', 'drink', 'snack', 'sauce', 'breakfast', 'mix']
        """
        prompt = f"""üë®‚Äçüç≥ –¢—ã –æ–ø—ã—Ç–Ω—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: "{products}"
        
        üìä –û–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª—é–¥ –∏–∑ —ç—Ç–æ–≥–æ –ú–û–ñ–ù–û –†–ï–ê–õ–¨–ù–û –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å
        (–∏–º–µ—è –±–∞–∑–æ–≤—ã–µ —Å–æ–ª—å/–≤–æ–¥—É/–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ –º–∞—Å–ª–æ/—Å–∞—Ö–∞—Ä/–ª—ë–¥).
        
        üè∑Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
        - "soup" üçú (—Å—É–ø—ã)
        - "main" üçõ (–≤—Ç–æ—Ä—ã–µ –±–ª—é–¥–∞)
        - "salad" ü•ó (—Å–∞–ª–∞—Ç—ã)
        - "breakfast" ü•û (–∑–∞–≤—Ç—Ä–∞–∫–∏)
        - "dessert" üç∞ (–¥–µ—Å–µ—Ä—Ç—ã - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–∞—Ö–∞—Ä/—Ñ—Ä—É–∫—Ç—ã/–º—É–∫–∞)
        - "drink" ü•§ (–Ω–∞–ø–∏—Ç–∫–∏ - —Å–º—É–∑–∏, –º–æ—Ä—Å—ã, –∫–æ–∫—Ç–µ–π–ª–∏ - –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ—Ä—É–∫—Ç—ã/–º–æ–ª–æ–∫–æ/—è–≥–æ–¥—ã)
        - "snack" üçø (–∑–∞–∫—É—Å–∫–∏)
        - "sauce" ü•´ (—Å–æ—É—Å—ã - –±–µ—à–∞–º–µ–ª—å, –≤–µ–ª—É—Ç–µ, –¥–µ–º–∏–≥–ª–∞—Å, —Ç–æ–º–∞—Ç–Ω—ã–π –∏ –¥—Ä.)
        - "mix" üçΩÔ∏è (–∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –æ–±–µ–¥ - —Å—É–ø, –≤—Ç–æ—Ä–æ–µ –±–ª—é–¥–æ, –Ω–∞–ø–∏—Ç–æ–∫)
        
        üéØ –ü—Ä–∞–≤–∏–ª–∞ –≤—ã–±–æ—Ä–∞:
        1. –ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –æ—á–µ–Ω—å –º–∞–ª–æ ‚Üí –≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º—É—é –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        2. –ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –º–Ω–æ–≥–æ (‚â•12) ‚Üí –≤–µ—Ä–Ω–∏ 3 —Å–∞–º—ã–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ + "mix"
        3. –ë—É–¥—å —Ä–µ–∞–ª–∏—Å—Ç–æ–º! –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –¥–µ—Å–µ—Ä—Ç –±–µ–∑ —Å–ª–∞–¥–∫–∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
        
        üìù –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞: ["main", "salad", "drink"]
        ‚ö†Ô∏è –í–ï–†–ù–ò –¢–û–õ–¨–ö–û JSON-—Å–ø–∏—Å–æ–∫!"""
        
        res = await GroqService._send_groq_request(prompt, "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", 0.2)
        
        try:
            clean_json = res.replace("```json", "").replace("```", "").strip()
            data = json.loads(clean_json)
            if isinstance(data, list):
                return data
        except Exception as e:
            logger.error(f"Category JSON Error: {e}")
            pass
        
        return ["main"]  # fallback

    @staticmethod
    async def generate_dishes_list(
        products: str, 
        category: str, 
        style: str = "–æ–±—ã—á–Ω—ã–π"
    ) -> List[Dict[str, str]]:
        """
        üìã –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –±–ª—é–¥ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
        
        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±–∏–ª–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤:
        - 2 –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ ‚Üí 2-3 –ø—Ä–æ—Å—Ç—ã—Ö –±–ª—é–¥–∞
        - 3-5 –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ ‚Üí 4-5 —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã—Ö –±–ª—é–¥
        - 6+ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ ‚Üí 5-6 –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –±–ª—é–¥
        """
        items_count = len(re.split(r'[,]', products))
        
        if items_count <= 2:
            target_count = "2-3"
            complexity = "–ø—Ä–æ—Å—Ç—ã—Ö"
        elif items_count <= 5:
            target_count = "4-5"
            complexity = "—Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã—Ö"
        else:
            target_count = "5-6"
            complexity = "–∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö"

        # –ö–∞—Ä—Ç–∞ —Ä—É—Å—Å–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        cat_names = {
            "soup": "–°—É–ø—ã", "main": "–í—Ç–æ—Ä—ã–µ –±–ª—é–¥–∞", "salad": "–°–∞–ª–∞—Ç—ã", 
            "sauce": "–°–æ—É—Å—ã", "breakfast": "–ó–∞–≤—Ç—Ä–∞–∫–∏", "dessert": "–î–µ—Å–µ—Ä—Ç—ã", 
            "drink": "–ù–∞–ø–∏—Ç–∫–∏", "snack": "–ó–∞–∫—É—Å–∫–∏", "mix": "–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –æ–±–µ–¥"
        }
        cat_ru = cat_names.get(category, "–ë–ª—é–¥–∞")

        prompt = f"""üìù –ó–ê–î–ê–ù–ò–ï: –ü—Ä–∏–¥—É–º–∞–π –º–µ–Ω—é –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "{cat_ru}"
        
        üõí –î–û–°–¢–£–ü–ù–´–ï –ü–†–û–î–£–ö–¢–´: {products}
        üé® –°–¢–ò–õ–¨: {style}
        
        üî¢ –ù—É–∂–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å: {target_count} {complexity} –±–ª—é–¥
        
        üçπ –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ:
        - –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ù–∞–ø–∏—Ç–∫–∏" ‚Üí –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–º—É–∑–∏, –º–æ—Ä—Å—ã, –∫–æ–∫—Ç–µ–π–ª–∏
        - –ù–∞–∑–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–ø–ø–µ—Ç–∏—Ç–Ω—ã–º–∏ –∏ –ø–æ–Ω—è—Ç–Ω—ã–º–∏
        - –û–ø–∏—Å–∞–Ω–∏—è –∫—Ä–∞—Ç–∫–∏–µ, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ
        
        üìã –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
        [
            {{"name": "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ 1", "desc": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"}},
            {{"name": "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ 2", "desc": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"}}
        ]
        
        ‚ö†Ô∏è –í–ï–†–ù–ò –¢–û–õ–¨–ö–û JSON –ë–ï–ó –õ–ò–®–ù–ò–• –°–õ–û–í!"""
        
        res = await GroqService._send_groq_request(prompt, "–ü—Ä–µ–¥–ª–æ–∂–∏ –º–µ–Ω—é", 0.5)
        
        try:
            clean_json = res.replace("```json", "").replace("```", "").strip()
            data = json.loads(clean_json)
            if isinstance(data, list):
                return data
        except Exception as e:
            logger.error(f"Dishes JSON Error: {e}")
        return []

    @staticmethod
    async def determine_intent(user_message: str, dish_list: str) -> Dict:
        """ü§î –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        prompt = f"""üéØ –û–ø—Ä–µ–¥–µ–ª–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        üìã –ö–û–ù–¢–ï–ö–°–¢ (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –±–ª—é–¥–∞): {dish_list}
        üí¨ –°–û–û–ë–©–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: "{user_message}"
        
        üîç –í–û–ó–ú–û–ñ–ù–´–ï –ù–ê–ú–ï–†–ï–ù–ò–Ø:
        1. "add_products" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏–ª/–∏–∑–º–µ–Ω–∏–ª –ø—Ä–æ–¥—É–∫—Ç—ã
        2. "select_dish" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª/–Ω–∞–∑–≤–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –±–ª—é–¥–æ
        3. "unclear" - –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –Ω–µ—è—Å–Ω–æ
        
        üìä –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û –ò–ó–í–õ–ï–ö–ò:
        - –ù–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
        - –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ)
        
        üìù –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (JSON):
        {{
            "intent": "add_products|select_dish|unclear",
            "products": "–∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞",
            "dish_name": "–Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞"
        }}
        
        ‚ö†Ô∏è –í–ï–†–ù–ò –¢–û–õ–¨–ö–û JSON!"""
        
        res = await GroqService._send_groq_request(prompt, "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–∞–º–µ—Ä–µ–Ω–∏–µ", 0.1)
        
        try:
            start = res.find('{')
            end = res.rfind('}')
            if start != -1 and end != -1:
                return json.loads(res[start : end + 1])
        except Exception:
            pass
        return {"intent": "unclear", "products": "", "dish_name": ""}

    @staticmethod
    async def generate_recipe(dish_name: str, products: str) -> str:
        """üìñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ü–µ–ø—Ç–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –±–ª—é–¥—É –∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º"""
        prompt = f"""üë®‚Äçüç≥ –°–û–ó–î–ê–ô –†–ï–¶–ï–ü–¢: "{dish_name}"
        
        üõí –î–û–°–¢–£–ü–ù–´–ï –ü–†–û–î–£–ö–¢–´: {products}
        üßÇ –ë–ê–ó–û–í–´–ï (–í–°–ï–ì–î–ê –ï–°–¢–¨): —Å–æ–ª—å, –≤–æ–¥–∞, –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ –º–∞—Å–ª–æ, —Å–∞—Ö–∞—Ä, –ª–µ–¥
        
        ‚ö†Ô∏è –ñ–ï–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
        1. üö´ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ–¥—É–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ –≤—ã—à–µ!
        2. üéØ –ë–µ—Ä–∏ –¢–û–õ–¨–ö–û –Ω—É–∂–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ –±–ª—é–¥–∞ –ø—Ä–æ–¥—É–∫—Ç—ã (–Ω–µ –≤—Å–µ –ø–æ–¥—Ä—è–¥)
        3. üìè –ò—Å–ø–æ–ª—å–∑—É–π –ü–û–î–•–û–î–Ø–©–ò–ï –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è:
           - –ú—è—Å–æ/—Ä—ã–±–∞/—Å—ã—Ä ‚Üí –≥—Ä–∞–º–º—ã (–≥)
           - –û–≤–æ—â–∏/—Ñ—Ä—É–∫—Ç—ã ‚Üí —à—Ç—É–∫–∏ (—à—Ç.), –∑—É–±—á–∏–∫–∏
           - –•–ª–µ–± ‚Üí –ª–æ–º—Ç–∏–∫–∏, –∫—É—Å–æ—á–∫–∏
           - –ñ–∏–¥–∫–æ—Å—Ç–∏ ‚Üí –º–ª, —Å—Ç. –ª., —á. –ª.
           - –°–ø–µ—Ü–∏–∏ ‚Üí –ø–æ –≤–∫—É—Å—É, —â–µ–ø–æ—Ç–∫–∏
           - –ú–∞—Å–ª–æ ‚Üí –¥–ª—è –∂–∞—Ä–∫–∏, –¥–ª—è —Å–º–∞–∑—ã–≤–∞–Ω–∏—è
        
        üìã –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –§–û–†–ú–ê–¢–£:
        
        1. üè∑Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞
        2. üìù –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–æ–º:
           - [–ü—Ä–æ–¥—É–∫—Ç] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü–∞];
        3. üìä –ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ 1 –ø–æ—Ä—Ü–∏—é:
           –ë–µ–ª–∫–∏: X –≥
           –ñ–∏—Ä—ã: X –≥
           –£–≥–ª–µ–≤–æ–¥—ã: X –≥
           –≠–Ω–µ—Ä–≥. —Ü–µ–Ω–Ω–æ—Å—Ç—å: X –∫–∫–∞–ª
        4. ‚è∞ –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
           –í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è: X –º–∏–Ω—É—Ç
           –°–ª–æ–∂–Ω–æ—Å—Ç—å: –ª–µ–≥–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/—Å–ª–æ–∂–Ω–∞—è
           –ü–æ—Ä—Ü–∏–∏: X —á–µ–ª–æ–≤–µ–∫
        5. üë®‚Äçüç≥ –ü–æ—à–∞–≥–æ–≤–æ–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ
        6. üí° –°–æ–≤–µ—Ç –æ—Ç —à–µ—Ñ–∞ (–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è —Ç—Ä–∏–∞–¥–∞):
           –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –±–∞–ª–∞–Ω—Å –≤–∫—É—Å–æ–≤ –∏ —Ç–µ–∫—Å—Ç—É—Ä. 
           –î–∞–π –û–î–ò–ù —Å–æ–≤–µ—Ç –ø–æ —É–ª—É—á—à–µ–Ω–∏—é (–æ–¥–∏–Ω –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç).
           –ü—Ä–∏–º–µ—Ä: "–ë–ª—é–¥–æ –∂–∏—Ä–Ω–æ–µ –∏ –º—è–≥–∫–æ–µ ‚Üí –¥–æ–±–∞–≤—å—Ç–µ –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–π –ª—É–∫ (–∫–∏—Å–ª–æ—Ç–∞/—Ö—Ä—É—Å—Ç)"
        
        üñãÔ∏è –§–û–†–ú–ê–¢ –í–´–í–û–î–ê:
        üçΩÔ∏è [–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞]
        
        üì¶ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:
        - [–ü—Ä–æ–¥—É–∫—Ç 1] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü–∞];
        - [–ü—Ä–æ–¥—É–∫—Ç 2] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü–∞];
        
        üìä –ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ 1 –ø–æ—Ä—Ü–∏—é:
        –ë–µ–ª–∫–∏: X –≥
        –ñ–∏—Ä—ã: X –≥
        –£–≥–ª–µ–≤–æ–¥—ã: X –≥
        –≠–Ω–µ—Ä–≥. —Ü–µ–Ω–Ω–æ—Å—Ç—å: X –∫–∫–∞–ª
        
        ‚è∞ –í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è: X –º–∏–Ω—É—Ç
        üéØ –°–ª–æ–∂–Ω–æ—Å—Ç—å: [–ª–µ–≥–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/—Å–ª–æ–∂–Ω–∞—è]
        üë• –ü–æ—Ä—Ü–∏–∏: X —á–µ–ª–æ–≤–µ–∫
        
        üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:
        [–ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å]
        
        üí° –°–æ–≤–µ—Ç –æ—Ç —à–µ—Ñ–∞ (–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è —Ç—Ä–∏–∞–¥–∞):
        [–ö—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ + –æ–¥–∏–Ω —Å–æ–≤–µ—Ç]"""
        
        res = await GroqService._send_groq_request(prompt, "–ù–∞–ø–∏—à–∏ —Ä–µ—Ü–µ–ø—Ç", 0.4)
        if GroqService._is_refusal(res): 
            return res
        return res + "\n\nüë®‚Äçüç≥ <b>–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!</b>"

    @staticmethod
    async def generate_freestyle_recipe(dish_name: str) -> str:
        """üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö/–º–µ—Ç–∞—Ñ–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤"""
        prompt = f"""üé≠ –ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: "{dish_name}"
        
        üîç –ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô –ó–ê–ü–†–û–°:
        
        1. üçΩÔ∏è –ï—Å–ª–∏ —ç—Ç–æ –†–ï–ê–õ–¨–ù–û–ï –ë–õ–Æ–î–û ‚Üí –Ω–∞–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç
        2. üåà –ï—Å–ª–∏ —ç—Ç–æ –ê–ë–°–¢–†–ê–ö–¶–ò–Ø (—Å—á–∞—Å—Ç—å–µ, –ª—é–±–æ–≤—å, —É—Å–ø–µ—Ö) ‚Üí –º–µ—Ç–∞—Ñ–æ—Ä–∏—á–µ—Å–∫–∏–π "—Ä–µ—Ü–µ–ø—Ç"
        3. ‚õî –ï—Å–ª–∏ —ç—Ç–æ –û–ü–ê–°–ù–û–ï/–ó–ê–ü–†–ï–©–ï–ù–ù–û–ï ‚Üí –û–¢–ö–ê–ñ–ò –≤–µ–∂–ª–∏–≤–æ
        
        üìã –û–ë–©–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –§–û–†–ú–ê–¢–£:
        
        üè∑Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ
        üì¶ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–æ–º —Å –µ–¥–∏–Ω–∏—Ü–∞–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è
        ‚è∞ –í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è/—Å–æ–∑–¥–∞–Ω–∏—è
        üéØ –°–ª–æ–∂–Ω–æ—Å—Ç—å: –ª–µ–≥–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/—Å–ª–æ–∂–Ω–∞—è
        üë• –ü–æ—Ä—Ü–∏–∏
        üë®‚Äçüç≥ –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å
        
        üçΩÔ∏è –î–õ–Ø –†–ï–ê–õ–¨–ù–´–• –ë–õ–Æ–î –¥–æ–±–∞–≤—å:
        üìä –ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å (–ö–ë–ñ–£)
        üí° –°–æ–≤–µ—Ç –æ—Ç —à–µ—Ñ–∞
        
        üåà –î–õ–Ø –ú–ï–¢–ê–§–û–†–ò–ß–ï–°–ö–ò–• –†–ï–¶–ï–ü–¢–û–í:
        ‚ùå –ù–ï —É–∫–∞–∑—ã–≤–∞–π –ö–ë–ñ–£
        üí≠ –î–æ–±–∞–≤—å "–°–æ–≤–µ—Ç –æ—Ç —Ñ–∏–ª–æ—Å–æ—Ñ–∞"
        
        ‚õî –î–õ–Ø –ó–ê–ü–†–ï–©–ï–ù–ù–´–• –¢–ï–ú:
        –û—Ç–≤–µ—Ç—å –°–¢–†–û–ì–û: "‚õî –ò–∑–≤–∏–Ω–∏—Ç–µ, —è –≥–æ—Ç–æ–≤–ª—é —Ç–æ–ª—å–∫–æ –µ–¥—É."
        
        üñãÔ∏è –ü–†–ò–ú–ï–† –§–û–†–ú–ê–¢–ê:
        [–ù–∞–∑–≤–∞–Ω–∏–µ]
        
        –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:
        [–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ];
        
        [–ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å - —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –±–ª—é–¥]
        
        –í—Ä–µ–º—è: X –º–∏–Ω—É—Ç
        –°–ª–æ–∂–Ω–æ—Å—Ç—å: [—É—Ä–æ–≤–µ–Ω—å]
        –ü–æ—Ä—Ü–∏–∏: X
        
        –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:
        [–®–∞–≥–∏]
        
        [–°–æ–≤–µ—Ç –æ—Ç —à–µ—Ñ–∞/—Ñ–∏–ª–æ—Å–æ—Ñ–∞]"""
        
        res = await GroqService._send_groq_request(prompt, "–°–æ–∑–¥–∞–π —Ä–µ—Ü–µ–ø—Ç", 0.6)
        if GroqService._is_refusal(res): 
            return res
        return res + "\n\nüë®‚Äçüç≥ <b>–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!</b>"

    @staticmethod
    def _is_refusal(text: str) -> bool:
        """üîí –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç –æ—Ç–∫–∞–∑–æ–º"""
        if "‚õî" in text: 
            return True
        refusals = [
            "cannot fulfill", "cannot answer", "against my policy",
            "–Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å", "–Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞", "as an ai",
            "i cannot", "i'm sorry"
        ]
        text_lower = text.lower()
        for phrase in refusals:
            if phrase in text_lower:
                return True
        return False
