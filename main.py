import asyncio
import os
import logging
import sys
from aiogram import Bot, Dispatcher
from aiogram.types import BotCommand
from config import TELEGRAM_TOKEN
from handlers import register_handlers
from aiohttp import web  # –î–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ Render

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (STDOUT –≤–∞–∂–µ–Ω –¥–ª—è Render!)
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s",
    stream=sys.stdout
)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
bot = Bot(token=TELEGRAM_TOKEN)
dp = Dispatcher()

# --- –í–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è Render (Health Check) ---
async def health_check(request):
    return web.Response(text="Bot is running OK")

async def start_web_server():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∑–∞–≥–ª—É—à–∫—É –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"""
    try:
        app = web.Application()
        app.router.add_get('/', health_check)
        app.router.add_get('/health', health_check)
        runner = web.AppRunner(app)
        await runner.setup()
        
        # Render –ø–µ—Ä–µ–¥–∞–µ—Ç –ø–æ—Ä—Ç —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è PORT
        port = int(os.environ.get("PORT", 8080))
        site = web.TCPSite(runner, '0.0.0.0', port)
        await site.start()
        logger.info(f"‚úÖ WEB SERVER STARTED ON PORT {port}")
    except Exception as e:
        logger.error(f"‚ùå Error starting web server: {e}")

# --- –ù–ê–°–¢–†–û–ô–ö–ê –ú–ï–ù–Æ ---
async def setup_bot_commands(bot: Bot):
    commands = [
        BotCommand(command="/start", description="üîÑ –†–µ—Å—Ç–∞—Ä—Ç / –Ω–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã"),
        BotCommand(command="/author", description="üë®‚Äçüíª –ê–≤—Ç–æ—Ä –±–æ—Ç–∞")
    ]
    try:
        await bot.set_my_commands(commands)
    except Exception as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã: {e}")

# --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ---
async def main():
    logger.info("ü§ñ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...")

    # 1. –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï: –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä!
    # –≠—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –î–û –ª—é–±—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Telegram, —á—Ç–æ–±—ã Render —Å—Ä–∞–∑—É —É–≤–∏–¥–µ–ª –æ—Ç–∫—Ä—ã—Ç—ã–π –ø–æ—Ä—Ç.
    await start_web_server()

    # 2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    register_handlers(dp)
    
    # 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è, –ø–æ—ç—Ç–æ–º—É –¥–µ–ª–∞–µ–º –ø–æ—Å–ª–µ —Å–µ—Ä–≤–µ—Ä–∞)
    await setup_bot_commands(bot)
    
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ polling...")
    
    # 4. –£–¥–∞–ª—è–µ–º –≤–µ–±—Ö—É–∫ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
    await bot.delete_webhook(drop_pending_updates=True)
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")